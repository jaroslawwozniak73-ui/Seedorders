<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SeedOrders ‚Äî wsp√≥lna baza (Supabase)</title>
  <meta name="theme-color" content="#0b1020"/>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1020;color:#e5e7eb;margin:0}
    .wrap{max-width:1100px;margin:14px auto;padding:0 10px}
    .row{display:flex;gap:8px;align-items:center}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:14px;margin:12px 0}
    h2{margin:0 0 8px 0}
    input,button,select,textarea{font:inherit;padding:9px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
    button{cursor:pointer}
    .grid{display:grid;gap:10px}
    .grid.e3{grid-template-columns:1fr 1fr 1fr}
    .grid.e2{grid-template-columns:1fr 1fr}
    .small{opacity:.9;font-size:.95rem}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #374151;padding:7px}
    th{background:#0b1220;text-align:left}
    .right{text-align:right}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2937;border:1px solid #374151}
    .muted{opacity:.75;font-size:.9rem}
    .ok{color:#22c55e}.warn{color:#f59e0b}.bad{color:#ef4444}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.0/dist/umd/supabase.js"></script>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="row" style="justify-content:space-between">
    <div><b>üå± SeedOrders ‚Äî wsp√≥lna baza</b></div>
    <div>Status: <span id="status" class="badge">offline</span></div>
  </div>

  <!-- PO≈ÅƒÑCZENIE -->
  <div class="card">
    <h2>Po≈ÇƒÖczenie z Supabase</h2>
    <div class="small" style="margin-bottom:6px">Te pola zostanƒÖ zapamiƒôtane w przeglƒÖdarce.</div>
    <div class="grid e3">
      <input id="url" placeholder="Supabase URL (https://xxxx.supabase.co)"/>
      <input id="key" placeholder="Anon public key (eyJ...)"/>
      <button id="connect">Po≈ÇƒÖcz i zapamiƒôtaj</button>
    </div>
  </div>

  <!-- CENNIK -->
  <div class="card">
    <h2>Cennik (seedorders_prices)</h2>

    <div class="grid e3">
      <input id="p_var" placeholder="Odmiana">
      <select id="p_cat">
        <option>Rzepak</option><option>Kukurydza</option><option>Zbo≈ºa</option><option>Inne</option>
      </select>
      <input id="p_price" type="number" step="0.01" placeholder="Cena">
    </div>

    <div class="grid e3" style="margin-top:8px">
      <input id="p_sup" placeholder="Dostawca (opcjonalnie)">
      <div class="row" style="gap:8px">
        <button id="p_save">Zapisz / zaktualizuj</button>
        <button id="p_delete" style="border-color:#ef4444;color:#fecaca;background:#1b0f10">Usu≈Ñ</button>
      </div>
      <div class="right"><button id="p_reload">Od≈õwie≈º listƒô</button></div>
    </div>

    <div id="p_list" class="small" style="margin-top:8px"></div>
  </div>

  <!-- KONTRAHENCI -->
  <div class="card">
    <h2>Kontrahenci (seedorders_clients)</h2>

    <div class="grid e3">
      <input id="c_name" placeholder="Nazwa kontrahenta">
      <input id="c_phone" placeholder="Telefon (opcjonalnie)">
      <button id="c_add">Dodaj</button>
    </div>

    <div class="row small" style="margin-top:8px">
      <input id="c_search" placeholder="Szukaj klienta..." style="flex:1">
      <div class="right"><button id="c_reload">Od≈õwie≈º listƒô</button></div>
    </div>

    <div id="c_list" class="small" style="margin-top:8px"></div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:600;margin-bottom:6px">Edytuj dane klienta</div>
      <div class="grid e3">
        <input id="e_name" placeholder="(kliknij klienta na li≈õcie powy≈ºej) ‚Äî nazwa" />
        <input id="e_phone" placeholder="Telefon" />
        <input id="e_street" placeholder="Ulica" />
        <input id="e_postal" placeholder="Kod" />
        <input id="e_city" placeholder="Miejscowo≈õƒá" />
        <input id="e_country" value="Polska" />
      </div>
      <div class="row" style="margin-top:8px">
        <button id="e_save">Zapisz zmiany</button>
        <span id="e_info" class="muted"></span>
      </div>
    </div>
  </div>

  <!-- DODAJ ZAM√ìWIENIE -->
  <div class="card">
    <h2>Dodaj zam√≥wienie (seedorders_orders + seedorders_items 1)</h2>

    <div class="grid e3">
      <input id="o_client" list="dl_clients" placeholder="Kontrahent (wpisz lub wybierz)">
      <datalist id="dl_clients"></datalist>
      <input id="o_phone" placeholder="Telefon (auto z kartoteki, mo≈ºna wpisaƒá)">
      <select id="o_cat">
        <option>Rzepak</option><option>Kukurydza</option><option>Zbo≈ºa</option><option>Inne</option>
      </select>
    </div>

    <div class="grid e3" style="margin-top:8px">
      <input id="o_var" list="dl_var" placeholder="Odmiana"><datalist id="dl_var"></datalist>
      <input id="o_qty" type="number" min="1" step="1" placeholder="Ilo≈õƒá">
      <input id="o_price" type="number" step="0.01" placeholder="Cena / szt.">
    </div>

    <div class="grid e3" style="margin-top:8px">
      <input id="o_sup" placeholder="Dostawca (opcjonalnie)">
      <input id="o_note" placeholder="Uwagi (opcjonalnie)">
      <button id="o_add">Dodaj pozycjƒô</button>
    </div>
  </div>

  <!-- ZAM√ìWIENIA (ostatnie) -->
  <div class="card">
    <h2>Zam√≥wienia (ostatnie)</h2>
    <div class="row small">
      <input id="o_search" placeholder="Szukaj: klient/odmiana/uwagi..." style="flex:1">
      <select id="o_status">
        <option value="wszystkie">Wszystkie statusy</option>
        <option value="nowe">Nowe</option>
        <option value="zam√≥wione">Zam√≥wione</option>
        <option value="dostarczone">Dostarczone</option>
        <option value="anulowane">Anulowane</option>
      </select>
      <button id="o_reload">Od≈õwie≈º</button>
    </div>
    <div id="o_list" style="margin-top:8px"></div>
  </div>

  <!-- RAPORTY: sumy + odebrane -->
  <div class="card">
    <h2>üìä Raporty: sumy & odebrane</h2>
    <div class="grid e3">
      <div><label>Od</label><br><input type="date" id="r_from"></div>
      <div><label>Do</label><br><input type="date" id="r_to"></div>
      <div>
        <label>Kategoria</label><br>
        <select id="r_cat">
          <option value="">(Wszystkie)</option>
          <option>Rzepak</option><option>Kukurydza</option><option>Zbo≈ºa</option><option>Inne</option>
        </select>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="r_run">Poka≈º sumy</button>
      <button id="r_deliveries">Poka≈º odebrane (szczeg√≥≈Çy)</button>
    </div>
    <div id="r_out" class="small" style="margin-top:8px"></div>
    <div id="r_out2" class="small" style="margin-top:8px"></div>
  </div>

</div>

<script>
(() => {
  // ===== Tools
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const money=(x)=> (Number(x)||0).toLocaleString('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2});
  function today(){ return new Date().toISOString().slice(0,10); }
  function firstDayOfMonth(){ const d=new Date(); return new Date(d.getFullYear(),d.getMonth(),1).toISOString().slice(0,10); }

  // ===== State
  let supa=null;
  let CACHE = { prices:[], clients:[], orders:[], items:[] };

  // ===== Po≈ÇƒÖczenie
  function saveCreds(){ localStorage.setItem('sb_url',$('#url').value.trim()); localStorage.setItem('sb_key',$('#key').value.trim()); }
  function loadCreds(){ $('#url').value=localStorage.getItem('sb_url')||''; $('#key').value=localStorage.getItem('sb_key')||''; }
  loadCreds();

  $('#connect').onclick = async ()=>{
    const url=$('#url').value.trim(), key=$('#key').value.trim();
    if(!url||!key){ alert('Wpisz URL i anon key.'); return; }
    supa = window.supabase.createClient(url,key);
    saveCreds();
    $('#status').textContent='online'; $('#status').classList.add('ok');
    await reloadAll();
  };

  if($('#url').value && $('#key').value){
    supa = window.supabase.createClient($('#url').value,$('#key').value);
    $('#status').textContent='online'; $('#status').classList.add('ok');
    reloadAll();
  }

  async function reloadAll(){
    await Promise.all([loadPrices(), loadClients(), loadOrders()]);
    // daty raportu
    $('#r_from').value = firstDayOfMonth();
    $('#r_to').value = today();
  }

  // ===== Cennik
  async function loadPrices(){
    if(!supa) return;
    const { data, error } = await supa.from('seedorders_prices').select('*').order('odmiana');
    if(error){ $('#p_list').textContent='B≈ÇƒÖd: '+error.message; return; }
    CACHE.prices = data||[];
    const rows = CACHE.prices.map(r=>({odmiana:r.odmiana,kategoria:r.kategoria,cena:Number(r.cena||0),dostawca:r.dostawca||''}));
    $('#p_list').innerHTML = rows.length
      ? `<table><thead><tr><th>Odmiana</th><th>Kategoria</th><th class="right">Cena</th><th>Dostawca</th></tr></thead><tbody>${
          rows.map(r=>`<tr data-var="${r.odmiana}" data-cat="${r.kategoria}">
            <td>${r.odmiana}</td><td>${r.kategoria}</td><td class="right">${money(r.cena)}</td><td>${r.dostawca||''}</td></tr>`).join('')
        }</tbody></table>`
      : `<div class="muted">Brak pozycji cennika.</div>`;
    refreshVarDatalist();
  }
  $('#p_reload').onclick = loadPrices;

  // klik w cennik -> uzupe≈Çnij pola
  document.addEventListener('click',(e)=>{
    const tr = e.target.closest('#p_list table tbody tr'); if(!tr) return;
    $('#p_var').value = tr.dataset.var || '';
    $('#p_cat').value = tr.dataset.cat || 'Rzepak';
    const priceCell = tr.children[2]?.textContent||'';
    $('#p_price').value = (priceCell.replace(/[^\d,.-]/g,'').replace(',','.')) || '';
    $('#p_sup').value = tr.children[3]?.textContent||'';
  });

  // upsert (odmiana,kategoria)
  $('#p_save').onclick = async()=>{
    if(!supa) return alert('Najpierw Po≈ÇƒÖcz.');
    const odm=$('#p_var').value.trim(); if(!odm) return alert('Podaj odmianƒô');
    const kat=$('#p_cat').value.trim();
    const cena=Number($('#p_price').value||0);
    const dost=$('#p_sup').value.trim()||null;
    const { error } = await supa.from('seedorders_prices')
      .upsert({ odmiana:odm,kategoria:kat,cena,dostawca:dost }, { onConflict:'odmiana,kategoria' });
    if(error) return alert('B≈ÇƒÖd: '+error.message);
    await loadPrices();
  };

  $('#p_delete').onclick = async()=>{
    if(!supa) return alert('Najpierw Po≈ÇƒÖcz.');
    const odm=$('#p_var').value.trim(); const kat=$('#p_cat').value.trim();
    if(!odm) return alert('Najpierw wpisz/kliknij odmianƒô.');
    if(!confirm('UsunƒÖƒá pozycjƒô cennika?')) return;
    const { error } = await supa.from('seedorders_prices').delete().eq('odmiana',odm).eq('kategoria',kat);
    if(error) return alert('B≈ÇƒÖd: '+error.message);
    $('#p_var').value=''; $('#p_price').value=''; $('#p_sup').value='';
    await loadPrices();
  };

  // ===== Kontrahenci
  async function loadClients(){
    if(!supa) return;
    const { data, error } = await supa.from('seedorders_clients').select('*').order('name');
    if(error){ $('#c_list').textContent='B≈ÇƒÖd: '+error.message; return; }
    CACHE.clients=data||[];
    renderClients();
  }
  function renderClients(){
    const q = ($('#c_search').value||'').toLowerCase();
    const rows = CACHE.clients.filter(c => [c.name,c.phone,c.street,c.city,c.postal_code].filter(Boolean).join(' ').toLowerCase().includes(q));
    $('#c_list').innerHTML = rows.length
      ? `<table><thead><tr><th>Nazwa</th><th>Telefon</th><th>Adres</th></tr></thead><tbody>${
          rows.map(c=>`<tr data-id="${c.id||''}" data-name="${c.name}">
            <td>${c.name}</td><td>${c.phone||''}</td>
            <td>${[c.street,c.postal_code,c.city,c.country].filter(Boolean).join(', ')}</td>
          </tr>`).join('')
        }</tbody></table>`
      : `<div class="muted">Brak kontrahent√≥w.</div>`;
    // datalist dla zam√≥wie≈Ñ
    const dl=$('#dl_clients'); dl.innerHTML='';
    CACHE.clients.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; dl.appendChild(o); });
  }
  $('#c_reload').onclick = loadClients;
  $('#c_search').oninput = renderClients;

  $('#c_add').onclick = async()=>{
    if(!supa) return alert('Najpierw Po≈ÇƒÖcz.');
    const name=$('#c_name').value.trim(); if(!name) return alert('Podaj nazwƒô');
    const phone=$('#c_phone').value.trim()||null;
    const { error } = await supa.from('seedorders_clients').insert({ name, phone });
    if(error) return alert('B≈ÇƒÖd: '+error.message);
    $('#c_name').value=''; $('#c_phone').value='';
    await loadClients();
  };

  // klik w klienta -> edycja
  document.addEventListener('click',(e)=>{
    const tr = e.target.closest('#c_list table tbody tr'); if(!tr) return;
    const c = CACHE.clients.find(x=>x.id===tr.dataset.id) || CACHE.clients.find(x=>x.name===tr.dataset.name);
    if(!c) return;
    $('#e_name').value=c.name||''; $('#e_phone').value=c.phone||'';
    $('#e_street').value=c.street||''; $('#e_postal').value=c.postal_code||'';
    $('#e_city').value=c.city||''; $('#e_country').value=c.country||'Polska';
    $('#e_save').dataset.id=c.id||''; $('#e_info').textContent='Za≈Çadowano klienta do edycji.';
  });

  $('#e_save').onclick = async()=>{
    const id=$('#e_save').dataset.id;
    const payload={
      name:$('#e_name').value.trim(),
      phone:$('#e_phone').value.trim()||null,
      street:$('#e_street').value.trim()||null,
      postal_code:$('#e_postal').value.trim()||null,
      city:$('#e_city').value.trim()||null,
      country:$('#e_country').value.trim()||null
    };
    if(!payload.name){ $('#e_info').textContent='Podaj nazwƒô'; return; }
    let q; if(id) q=supa.from('seedorders_clients').update(payload).eq('id',id);
    else q=supa.from('seedorders_clients').update(payload).eq('name',payload.name);
    const { error } = await q;
    $('#e_info').textContent = error ? ('B≈ÇƒÖd: '+error.message) : 'Zapisano ‚úÖ (kliknij ‚ÄûOd≈õwie≈º listƒô‚Äù).';
    if(!error) loadClients();
  };

  // ===== Dodaj zam√≥wienie
  function refreshVarDatalist(){
    const cat = $('#o_cat').value.trim();
    const dl = $('#dl_var'); dl.innerHTML='';
    CACHE.prices.filter(r=>!cat || r.kategoria===cat).forEach(r=>{
      const o=document.createElement('option'); o.value=r.odmiana; dl.appendChild(o);
    });
  }
  $('#o_cat').addEventListener('change', refreshVarDatalist);

  $('#o_client').addEventListener('change', ()=>{
    const name=($('#o_client').value||'').trim().toLowerCase();
    const cl=CACHE.clients.find(c=>c.name.toLowerCase()===name);
    if(cl && cl.phone) $('#o_phone').value=cl.phone;
  });
  $('#o_var').addEventListener('change', ()=>{
    const v=($('#o_var').value||'').trim();
    const p=CACHE.prices.find(x=>x.odmiana===v);
    if(p){ $('#o_cat').value=p.kategoria; $('#o_price').value=p.cena; $('#o_sup').value=p.dostawca||''; refreshVarDatalist(); }
  });

  $('#o_add').onclick = async()=>{
    if(!supa) return alert('Najpierw Po≈ÇƒÖcz.');
    const klient=($('#o_client').value||'').trim(); if(!klient) return alert('Podaj kontrahenta');
    const telefon=($('#o_phone').value||'').trim()||null;
    const kategoria=$('#o_cat').value.trim();
    const odm=($('#o_var').value||'').trim(); if(!odm) return alert('Podaj odmianƒô');
    const qty=parseInt($('#o_qty').value||'0',10); if(!qty) return alert('Podaj ilo≈õƒá');
    const cena=Number($('#o_price').value||0);
    const dost=($('#o_sup').value||'').trim()||null;
    const uwagi=($('#o_note').value||'').trim()||null;

    // klient (auto)
    let cl=CACHE.clients.find(c=>c.name.toLowerCase()===klient.toLowerCase());
    if(!cl){
      const ins=await supa.from('seedorders_clients').insert({name:klient,phone:telefon}).select('*').single();
      if(ins.error) return alert('B≈ÇƒÖd klient: '+ins.error.message);
      cl=ins.data; CACHE.clients.push(cl);
    }

    // zam√≥wienie z dzi≈õ (nieanulowane) albo nowe
    let ord=CACHE.orders.find(o => (o.klient||'').toLowerCase()===klient.toLowerCase() && (o.status||'nowe')!=='anulowane' && String(o.created_at||'').slice(0,10)===today());
    if(!ord){
      const ins=await supa.from('seedorders_orders').insert({klient,telefon,uwagi:uwagi||'',status:'nowe',client_id:cl.id||null}).select('*').single();
      if(ins.error) return alert('B≈ÇƒÖd tworzenia zam√≥wienia: '+ins.error.message);
      ord=ins.data; CACHE.orders.unshift(ord);
    }else{
      const patch={}; if(telefon) patch.telefon=telefon; if(uwagi) patch.uwagi=(ord.uwagi||'')+'\n'+uwagi; if(cl.id) patch.client_id=cl.id;
      if(Object.keys(patch).length){ await supa.from('seedorders_orders').update(patch).eq('id',ord.id); }
    }

    // pozycja
    const ins2 = await supa.from('seedorders_items 1').insert({
      order_id:ord.id, "kategoria":kategoria, "odmiana":odm, "ilo≈õƒá":qty, "cena":cena, "dostawca":dost
    });
    if(ins2.error) return alert('B≈ÇƒÖd pozycji: '+ins2.error.message);

    $('#o_var').value=''; $('#o_qty').value='1'; $('#o_price').value=''; $('#o_note').value='';
    await loadOrders();
  };

  // ===== Zam√≥wienia + pozycje + wydania
  async function loadOrders(){
    if(!supa) return;
    const [o,i] = await Promise.all([
      supa.from('seedorders_orders').select('*').order('created_at',{ascending:false}).limit(200),
      supa.from('seedorders_items 1').select('*')
    ]);
    CACHE.orders=o.data||[]; CACHE.items=i.data||[];
    renderOrders();
  }

  function itemsForOrder(id){
    return CACHE.items.filter(p=>p.order_id===id).map(r=>{
      const ordered = (r.ordered_qty!=null)? Number(r.ordered_qty) : Number(r['ilo≈õƒá']||0);
      const delivered = Number(r.delivered_qty||0);
      const remaining = (r.remaining_qty!=null)? Number(r.remaining_qty) : Math.max(ordered - delivered, 0);
      return { id:r.id, odmiana:r['odmiana'], kategoria:r['kategoria'], ordered, delivered, remaining };
    });
  }
  function colorFor(rem,del){ return rem>0 && del>0 ? 'warn' : (rem>0 ? 'bad' : 'ok'); }

  function renderOrders(){
    const q=($('#o_search').value||'').toLowerCase();
    const st=$('#o_status').value;
    let arr=CACHE.orders.slice();
    if(st!=='wszystkie') arr=arr.filter(o=>(o.status||'nowe')===st);
    if(q) arr=arr.filter(o=>{
      const txt=[o.klient,o.telefon,o.uwagi].filter(Boolean).join(' ').toLowerCase();
      const iv=itemsForOrder(o.id).map(p=>p.odmiana).join(' ').toLowerCase();
      return (txt+' '+iv).includes(q);
    });

    const box=$('#o_list'); box.innerHTML='';
    if(!arr.length){ box.innerHTML='<div class="muted">Brak zam√≥wie≈Ñ.</div>'; return; }

    arr.forEach(o=>{
      const its=itemsForOrder(o.id);
      const div=document.createElement('div'); div.className='card';
      div.innerHTML=`
        <div class="row" style="justify-content:space-between">
          <div>
            <span class="badge">${(o.status||'nowe')}</span>
            <b>${String(o.created_at||'').slice(0,10)}</b>
            <span class="muted">‚Ä¢</span>
            <b>${o.klient||''}</b> ${o.telefon?('‚Ä¢ '+o.telefon):''}
            ${o.uwagi?(`<div class="muted">Uwagi: ${o.uwagi}</div>`):''}
          </div>
          <div class="row">
            <select class="o-st">
              <option value="nowe">nowe</option>
              <option value="zam√≥wione">zam√≥wione</option>
              <option value="dostarczone">dostarczone</option>
              <option value="anulowane">anulowane</option>
            </select>
            <button class="o-del" style="margin-left:8px">Usu≈Ñ zam√≥wienie</button>
          </div>
        </div>
        <div class="small" style="margin-top:6px">
          ${its.length?`
            <table>
              <thead><tr>
                <th>Odmiana</th><th class="right">Zam√≥wiono</th><th class="right">Wydano</th><th class="right">Pozosta≈Ço</th><th class="right">Wydaj</th>
              </tr></thead>
              <tbody>
                ${its.map(p=>{
                  const cls=colorFor(p.remaining,p.delivered);
                  return `<tr data-id="${p.id}">
                    <td>${p.kategoria||''} ‚Ä¢ ${p.odmiana||''}</td>
                    <td class="right">${p.ordered}</td>
                    <td class="right">${p.delivered}</td>
                    <td class="right ${cls}">${p.remaining}</td>
                    <td class="right"><input type="number" step="0.001" value="1" style="width:90px"> <button class="ship">OK</button></td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          `:`<div class="muted">Brak pozycji.</div>`}
        </div>
      `;
      // status
      div.querySelector('.o-st').value=(o.status||'nowe');
      div.querySelector('.o-st').addEventListener('change', async (ev)=>{
        await supa.from('seedorders_orders').update({status:ev.target.value}).eq('id',o.id);
      });
      // usu≈Ñ zam√≥wienie
      div.querySelector('.o-del').addEventListener('click', async ()=>{
        if(!confirm('UsunƒÖƒá zam√≥wienie?')) return;
        await supa.from('seedorders_orders').delete().eq('id',o.id);
        await loadOrders();
      });
      // czƒô≈õciowe wydanie
      div.addEventListener('click', async (e)=>{
        const btn=e.target.closest('button.ship'); if(!btn) return;
        const tr=btn.closest('tr'); const itemId=tr.dataset.id;
        const delta=Number(tr.querySelector('input').value||0); if(!delta) return;
        btn.disabled=true; btn.textContent='‚Ä¶';
        try{
          const res=await supa.rpc('upsert_delivery_simple',{p_item_id:itemId,p_delta:delta});
          const r=(res.data&&res.data[0])||{};
          const tds=tr.children;
          tds[2].textContent=Number(r.delivered_qty||0);
          const remaining=(r.remaining_qty!=null)? Number(r.remaining_qty) : Math.max(Number(r.ordered_qty||0)-Number(r.delivered_qty||0),0);
          tds[3].textContent=remaining;
          tds[3].className='right '+(remaining>0 && Number(r.delivered_qty||0)>0?'warn':(remaining>0?'bad':'ok'));
        }catch(err){ alert('B≈ÇƒÖd wydania: '+(err.message||err)); }
        finally{ btn.disabled=false; btn.textContent='OK'; }
      });

      $('#o_list').appendChild(div);
    });
  }
  $('#o_reload').onclick=loadOrders;
  $('#o_search').oninput=renderOrders;
  $('#o_status').onchange=renderOrders;

  // ===== Raporty: SUMY + ODEBRANE
  async function runSummary(showDetails=false){
    if(!supa) return;
    const from=$('#r_from').value||firstDayOfMonth();
    const to=$('#r_to').value||today();
    const cat=$('#r_cat').value||'';

    // Pobierz zam√≥wienia w zakresie dat
    const { data:orders, error:oErr } = await supa
      .from('seedorders_orders').select('id,created_at,klient,telefon')
      .gte('created_at', from+'T00:00:00').lte('created_at', to+'T23:59:59').order('created_at',{ascending:false});
    if(oErr){ $('#r_out').textContent='B≈ÇƒÖd: '+oErr.message; return; }
    if(!orders?.length){ $('#r_out').innerHTML='<div class="muted">Brak danych w tym zakresie.</div>'; $('#r_out2').innerHTML=''; return; }

    const ids = orders.map(o=>o.id);
    // Pobierz pozycje dla tych zam√≥wie≈Ñ
    let q = supa.from('seedorders_items 1').select('*').in('order_id', ids);
    if(cat) q = q.eq('kategoria', cat);
    const { data:items, error:iErr } = await q;
    if(iErr){ $('#r_out').textContent='B≈ÇƒÖd: '+iErr.message; return; }

    // Agregacja SUM
    const map = new Map();
    items.forEach(r=>{
      const k = (r.kategoria||'')+'||'+(r['odmiana']||'');
      const ord = (r.ordered_qty!=null)? Number(r.ordered_qty) : Number(r['ilo≈õƒá']||0);
      const del = Number(r.delivered_qty||0);
      const rem = (r.remaining_qty!=null)? Number(r.remaining_qty) : Math.max(ord-del,0);
      const prev = map.get(k)||{kategoria:r.kategoria,odmiana:r['odmiana'],ordered:0,delivered:0,remaining:0};
      prev.ordered += ord; prev.delivered += del; prev.remaining += rem; map.set(k,prev);
    });
    const rows = Array.from(map.values()).sort((a,b)=> (a.kategoria||'').localeCompare(b.kategoria||'') || (a.odmiana||'').localeCompare(b.odmiana||''));
    const tot = rows.reduce((t,r)=>({ordered:t.ordered+r.ordered,delivered:t.delivered+r.delivered,remaining:t.remaining+r.remaining}),{ordered:0,delivered:0,remaining:0});

    $('#r_out').innerHTML = `
      <table>
        <thead><tr><th>Kategoria</th><th>Odmiana</th><th class="right">Zam√≥wiono</th><th class="right">Wydano</th><th class="right">Pozosta≈Ço</th></tr></thead>
        <tbody>
          ${rows.map(r=>`<tr>
            <td>${r.kategoria||''}</td><td>${r.odmiana||''}</td>
            <td class="right">${r.ordered}</td>
            <td class="right">${r.delivered}</td>
            <td class="right">${r.remaining}</td>
          </tr>`).join('')}
        </tbody>
        <tfoot>
          <tr>
            <th colspan="2" class="right">RAZEM</th>
            <th class="right">${tot.ordered}</th>
            <th class="right">${tot.delivered}</th>
            <th class="right">${tot.remaining}</th>
          </tr>
        </tfoot>
      </table>
      <div class="muted" style="margin-top:6px">Zakres: ${from} ‚Äì ${to} ${cat?('‚Ä¢ '+cat):''}</div>
    `;

    if(!showDetails){ $('#r_out2').innerHTML=''; return; }

    // Szczeg√≥≈Çy ODEBRANE (kto odebra≈Ç)
    // Filtr: delivered_qty > 0
    const itemsByOrder = items.filter(r => Number(r.delivered_qty||0) > 0);
    if(!itemsByOrder.length){ $('#r_out2').innerHTML='<div class="muted">Brak odebranych pozycji w tym zakresie.</div>'; return; }
    const oMap = new Map(orders.map(o=>[o.id,o]));
    const det = itemsByOrder.map(r=>{
      const ord = oMap.get(r.order_id)||{};
      return {
        date: String(ord.created_at||'').slice(0,10),
        klient: ord.klient||'',
        odmiana: r['odmiana']||'',
        kategoria: r.kategoria||'',
        delivered: Number(r.delivered_qty||0),
        remaining: (r.remaining_qty!=null)? Number(r.remaining_qty) : Math.max(((r.ordered_qty!=null)? Number(r.ordered_qty):Number(r['ilo≈õƒá']||0)) - Number(r.delivered_qty||0),0)
      };
    }).sort((a,b)=> a.date<b.date?1:-1);

    $('#r_out2').innerHTML = `
      <div style="margin-top:10px;font-weight:600">Odebrane (szczeg√≥≈Çy)</div>
      <table>
        <thead><tr>
          <th>Data</th><th>Klient</th><th>Kategoria</th><th>Odmiana</th>
          <th class="right">Wydano</th><th class="right">Pozosta≈Ço</th>
        </tr></thead>
        <tbody>
          ${det.map(r=>`<tr>
            <td>${r.date}</td><td>${r.klient}</td><td>${r.kategoria}</td><td>${r.odmiana}</td>
            <td class="right">${r.delivered}</td><td class="right">${r.remaining}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    `;
  }

  $('#r_run').onclick = ()=>runSummary(false);
  $('#r_deliveries').onclick = ()=>runSummary(true);

  // ===== Start
  $('#o_qty').value='1';
})();
</script>
</body>
</html>
