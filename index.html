<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SeedOrders â€” wspÃ³lna baza</title>
  <meta name="theme-color" content="#001020">
  <style>
    :root{--bg:#001020;--card:#111827;--edge:#374151;--accent:#1f2937;--txt:#e5e7eb;--muted:#9ca3af;--ok:#065f46;--warn:#92400e;--bad:#7f1d1d}
    html,body{background:var(--bg);color:var(--txt);margin:0;font:14px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 12px}
    h2{margin:10px 0}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:12px;margin:12px 0}
    .row{display:flex;gap:8px;align-items:center}
    .row>*,input,select,button,textarea{border:1px solid var(--edge);background:#0b1228;color:var(--txt);padding:9px;border-radius:10px}
    input,select,button,textarea{outline:none}
    button{cursor:pointer;background:#2563eb;border-color:#2563eb}
    button.secondary{background:#0b1228}
    .grid{display:grid;gap:10px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    .muted{color:var(--muted)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#0b1228;border:1px solid var(--edge);font-size:12px;color:#9ca3af}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--edge);padding:8px;text-align:left}
    .right{text-align:right}
    .sticky-top{position:sticky;top:0;background:var(--bg);z-index:5;padding:8px 0;margin:-8px 0 8px}
    .collapse-head{display:flex;gap:10px;align-items:center;cursor:pointer}
    .collapse-body{margin-top:10px}
    .pill{padding:3px 9px;border-radius:999px;border:1px solid var(--edge);background:#0b1228}
    /* Kolory zamÃ³wieÅ„ */
    .ord--done{box-shadow:inset 0 0 0 2px var(--bad);background:linear-gradient(0deg, rgba(127,29,29,.12), transparent)}
    .ord--partial{box-shadow:inset 0 0 0 2px var(--warn);background:linear-gradient(0deg, rgba(146,64,14,.12), transparent)}
    .ord--new{box-shadow:inset 0 0 0 2px #0b5; background:linear-gradient(0deg, rgba(0,187,85,.12), transparent)}
    .ord-head{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .ord-title{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .ord-actions{display:flex;gap:6px;align-items:center}
    .mt8{margin-top:8px}
    .hide{display:none}
    .ok{color:#22c55e}
    .err{color:#ef4444}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row sticky-top">
      <div><b>ðŸŒ± SeedOrders â€” wspÃ³lna baza</b></div>
      <div class="badge">Status: <span id="status">offline</span></div>
    </div>

    <!-- PoÅ‚Ä…czenie (podglÄ…d; Å‚Ä…czenie staÅ‚e w kodzie) -->
    <div class="card">
      <h2>PoÅ‚Ä…czenie z Supabase</h2>
      <div class="row"><span class="muted">PoÅ‚Ä…czenie jest wpisane w kodzie. Pola poniÅ¼ej to tylko podglÄ…d.</span></div>
      <div class="grid g3">
        <input id="url" placeholder="Supabase URL" readonly>
        <input id="key" placeholder="Anon public key" readonly>
        <button id="connect" disabled>PoÅ‚Ä…czono (staÅ‚e)</button>
      </div>
    </div>

    <!-- Cennik -->
    <div class="card">
      <div class="collapse-head" data-collapse="#price-body">
        <h2 style="margin:0">Cennik (seedorders_prices)</h2>
        <span class="muted">â€” kliknij, aby pokazaÄ‡/ukryÄ‡</span>
      </div>
      <div class="collapse-body" id="price-body">
        <div class="row">
          <label class="pill"><input type="checkbox" id="pf_r" checked> Rzepak</label>
          <label class="pill"><input type="checkbox" id="pf_k" checked> Kukurydza</label>
          <label class="pill"><input type="checkbox" id="pf_z" checked> ZboÅ¼a</label>
          <label class="pill"><input type="checkbox" id="pf_i" checked> Inne</label>
          <span class="muted">â€” odhacz, aby filtrowaÄ‡ listÄ™ odmian</span>
          <button id="p_refresh" class="secondary right" style="margin-left:auto">OdÅ›wieÅ¼</button>
        </div>
        <div class="grid g3 mt8">
          <input id="p_var" list="dl_var" placeholder="Odmiana">
          <select id="p_cat">
            <option value="Rzepak">Rzepak</option>
            <option value="Kukurydza">Kukurydza</option>
            <option value="ZboÅ¼a">ZboÅ¼a</option>
            <option value="Inne">Inne</option>
          </select>
          <input id="p_price" type="number" step="0.01" placeholder="Cena">
        </div>
        <div class="grid g3 mt8">
          <input id="p_sup" placeholder="Dostawca (opcjonalnie)">
          <button id="p_save">Zapisz / zaktualizuj</button>
          <button id="p_del" class="secondary">UsuÅ„</button>
        </div>
        <div id="p_list" class="mt8"></div>
        <datalist id="dl_var"></datalist>
      </div>
    </div>

    <!-- Kontrahenci -->
    <div class="card">
      <div class="collapse-head" data-collapse="#clients-body">
        <h2 style="margin:0">Kontrahenci (seedorders_clients)</h2>
        <span class="muted">â€” kliknij, aby pokazaÄ‡/ukryÄ‡</span>
      </div>
      <div class="collapse-body" id="clients-body">
        <div class="grid g3">
          <input id="c_name" placeholder="Nazwa (np. Jan Kowalski)">
          <input id="c_phone" placeholder="Telefon">
          <input id="c_street" placeholder="Ulica (np. Topolowa 1)">
        </div>
        <div class="grid g3 mt8">
          <input id="c_postal" placeholder="Kod (np. 09-230)">
          <input id="c_city" placeholder="MiejscowoÅ›Ä‡">
          <input id="c_country" placeholder="Polska" value="Polska">
        </div>
        <div class="row mt8">
          <button id="c_new" class="secondary">Nowy</button>
          <button id="c_save">Zapisz</button>
          <span id="c_out" class="muted">Zapisano âœ…</span>
          <input id="c_search" class="right" placeholder="Szukaj klienta...">
          <button id="c_reload" class="secondary">OdÅ›wieÅ¼ listÄ™</button>
        </div>
        <div class="row mt8">
          <button id="c_toggle" class="secondary">PokaÅ¼ / ukryj listÄ™ kontrahentÃ³w</button>
        </div>
        <div id="c_list" class="mt8"></div>
      </div>
    </div>

    <!-- ZamÃ³wienia -->
    <div class="card">
      <h2>ZamÃ³wienia (ostatnie)</h2>
      <div class="grid g3">
        <input id="o_client" list="dl_clients" placeholder="Kontrahent">
        <input id="o_phone" placeholder="Telefon (auto)">
        <select id="o_cat">
          <option>Rzepak</option><option>Kukurydza</option><option>ZboÅ¼a</option><option>Inne</option>
        </select>
      </div>
      <div class="grid g3 mt8">
        <input id="o_var" list="dl_var" placeholder="Odmiana">
        <input id="o_qty" type="number" min="1" step="1" value="1" placeholder="IloÅ›Ä‡">
        <input id="o_price" type="number" step="0.01" placeholder="Cena / szt.">
      </div>
      <div class="grid g3 mt8">
        <input id="o_sup" placeholder="Dostawca (opcjonalnie)">
        <input id="o_note" placeholder="Uwagi (opcjonalnie)">
        <button id="o_add">Dodaj pozycjÄ™</button>
      </div>
      <div class="row mt8">
        <input id="o_search" placeholder="Szukaj: klient/odmiana/uwagi..." style="flex:1">
        <select id="o_status">
          <option value="wszystkie">Wszystkie statusy</option>
          <option value="zamÃ³wione">zamÃ³wione</option>
          <option value="w realizacji">w realizacji</option>
          <option value="dostarczone">dostarczone</option>
          <option value="anulowane">anulowane</option>
        </select>
        <button id="o_reload" class="secondary">OdÅ›wieÅ¼</button>
      </div>
      <div id="o_list" class="mt8"></div>
      <datalist id="dl_clients"></datalist>
    </div>

    <!-- Raporty -->
    <div class="card">
      <h2>ðŸ“Š Raporty</h2>
      <div class="grid g3">
        <div><label>Od</label><br><input type="date" id="r_from"></div>
        <div><label>Do</label><br><input type="date" id="r_to"></div>
        <div>
          <label>Kategoria</label><br>
          <select id="r_cat">
            <option value="(Wszystkie)">(Wszystkie)</option>
            <option value="Rzepak">Rzepak</option>
            <option value="Kukurydza">Kukurydza</option>
            <option value="ZboÅ¼a">ZboÅ¼a</option>
            <option value="Inne">Inne</option>
          </select>
        </div>
      </div>
      <div class="row mt8">
        <button id="r_sums">PokaÅ¼ sumy</button>
        <button id="r_missing" class="secondary">PokaÅ¼ braki (pozostaÅ‚o)</button>
        <button id="r_csv" class="secondary">Pobierz CSV</button>
        <span id="r_info" class="muted"></span>
      </div>
      <div class="row mt8">
        <input id="r_year" value="2025" style="width:140px">
        <button id="r_year_btn" class="secondary">Raport roczny: kto/co/ile</button>
      </div>
      <div id="r_out" class="mt8"></div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.0/dist/umd/supabase.js"></script>
  <script>
  /************** 1) KONFIGURACJA STAÅEGO POÅÄ„CZENIA **************/
  const SUPABASE_URL_FIXED  = "https://llatxyfdpurbniewhjft.supabase.co";
  // ðŸ‘‰ jeÅ›li kiedyÅ› wpisaÅ‚eÅ› klucz w tej przeglÄ…darce, zadziaÅ‚a z localStorage.
  //    JeÅ›li nie â€“ WKLEJ SWÃ“J ANON KEY w cudzysÅ‚owie zamiast PASTE_ME:
  const SUPABASE_ANON_FIXED = localStorage.getItem('sb_key') || "PASTE_ME";

  const $ = (q,root=document)=>root.querySelector(q);
  const $$= (q,root=document)=>Array.from(root.querySelectorAll(q));
  const money = n => (Number(n)||0).toFixed(2).replace('.',',');

  const setStatus = t => { const el=$('#status'); if(el) el.textContent=t; };
  const todayStr = () => new Date().toISOString().slice(0,10);
  const firstDayMonth = () => { const d=new Date(); return new Date(d.getFullYear(),d.getMonth(),1).toISOString().slice(0,10); }

  // utwÃ³rz klienta supabase
  let supa = null;
  function createClient(){
    if(!SUPABASE_URL_FIXED || !SUPABASE_ANON_FIXED || SUPABASE_ANON_FIXED==="PASTE_ME"){ setStatus('offline'); return null; }
    try{
      const c = window.supabase.createClient(SUPABASE_URL_FIXED, SUPABASE_ANON_FIXED);
      localStorage.setItem('sb_url', SUPABASE_URL_FIXED);
      localStorage.setItem('sb_key', SUPABASE_ANON_FIXED);
      $('#url').value = SUPABASE_URL_FIXED;
      $('#key').value = SUPABASE_ANON_FIXED.slice(0,10)+'â€¦'; // maska
      setStatus('online');
      return c;
    }catch(e){ console.error(e); setStatus('offline'); return null; }
  }
  // jeÅ›li localStorage ma klucz â€“ uÅ¼yj go; w przeciwnym razie pokaÅ¼ offline
  if(localStorage.getItem('sb_key') && SUPABASE_ANON_FIXED==="PASTE_ME"){
    // przepisz z localStorage do staÅ‚ej runtime
    window.SB_KEY_RUNTIME = localStorage.getItem('sb_key');
  }
  supa = (SUPABASE_ANON_FIXED==="PASTE_ME" && window.SB_KEY_RUNTIME)
    ? (function(){ const c=window.supabase.createClient(SUPABASE_URL_FIXED, window.SB_KEY_RUNTIME); setStatus('online'); $('#url').value=SUPABASE_URL_FIXED; $('#key').value=window.SB_KEY_RUNTIME.slice(0,10)+'â€¦'; return c; })()
    : createClient();

  /************** 2) PAMIÄ˜Ä† W PRZEGLÄ„DARCE **************/
  let CACHE = {prices:[], clients:[], orders:[], items:[]};

  /************** 3) POMOCNICZE **************/
  function collapseInit(){
    $$('[data-collapse]').forEach(h=>{
      h.addEventListener('click',()=>{
        const sel = h.getAttribute('data-collapse');
        const el = document.querySelector(sel);
        if(!el) return;
        el.classList.toggle('hide');
      });
    });
    // domyÅ›lne
    $('#c_list').classList.add('hide');
    $('#price-body').classList.remove('hide');
    $('#clients-body').classList.remove('hide');
  }

  /************** 4) CENNIK **************/
  async function loadPrices(){
    if(!supa) return;
    const { data, error } = await supa.from('seedorders_prices').select('*').order('odmiana');
    if(error){ $('#p_list').innerHTML = `<div class="err">BÅ‚Ä…d: ${error.message}</div>`; return; }
    CACHE.prices = data||[];
    renderPrices();
    fillVarDatalist();
  }

  function renderPrices(){
    const pf = {
      Rzepak: $('#pf_r').checked,
      Kukurydza: $('#pf_k').checked,
      'ZboÅ¼a': $('#pf_z').checked,
      'Inne': $('#pf_i').checked
    };
    const rows = CACHE.prices.filter(r=>pf[r.kategoria]!==false);
    const html = rows.length
      ? `<table><thead><tr><th>Odmiana</th><th>Kategoria</th><th class="right">Cena</th><th>Dostawca</th></tr></thead><tbody>`+
        rows.map(r=>`<tr><td>${r.odmiana}</td><td>${r.kategoria}</td><td class="right">${money(r.cena)} zÅ‚</td><td>${r.dostawca||''}</td></tr>`).join('')+
        `</tbody></table>`
      : `<div class="muted">Brak pozycji.</div>`;
    $('#p_list').innerHTML = html;
  }

  function fillVarDatalist(){
    const dl = $('#dl_var'); dl.innerHTML='';
    CACHE.prices.forEach(r=>{ const o=document.createElement('option'); o.value = r.odmiana; dl.appendChild(o); });
  }

  async function upsertPrice(){
    if(!supa) return alert('Brak poÅ‚Ä…czenia (wklej anon key w kodzie lub ustawiony w przeglÄ…darce).');
    const odm = $('#p_var').value.trim();
    const kat = $('#p_cat').value;
    const cena= Number($('#p_price').value||0);
    const dos = $('#p_sup').value.trim() || null;
    if(!odm){ alert('Podaj odmianÄ™'); return; }
    const { error } = await supa.from('seedorders_prices')
      .upsert({ odmiana:odm, kategoria:kat, cena, dostawca:dos })
      .select().single();
    if(error){ alert('BÅ‚Ä…d: '+error.message); return; }
    $('#p_var').value=''; $('#p_price').value=''; $('#p_sup').value='';
    await loadPrices();
  }
  async function deletePrice(){
    const odm = $('#p_var').value.trim();
    if(!odm){ alert('Podaj odmianÄ™ (do usuniÄ™cia)'); return; }
    const { error } = await supa.from('seedorders_prices').delete().eq('odmiana',odm);
    if(error){ alert('BÅ‚Ä…d: '+error.message); return; }
    $('#p_var').value=''; await loadPrices();
  }

  /************** 5) KONTRAHENCI **************/
  function clearClientForm(){
    $('#c_name').value=''; $('#c_phone').value='';
    $('#c_street').value=''; $('#c_postal').value=''; $('#c_city').value=''; $('#c_country').value='Polska';
  }
  async function loadClients(){
    const { data, error } = await supa.from('seedorders_clients').select('*').order('name');
    if(error){ $('#c_list').innerHTML=`<div class="err">BÅ‚Ä…d: ${error.message}</div>`; return; }
    CACHE.clients = data||[];
    renderClients();
    const dl=$('#dl_clients'); dl.innerHTML=''; CACHE.clients.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; dl.appendChild(o);});
  }
  function renderClients(){
    const q = $('#c_search').value.trim().toLowerCase();
    const rows = CACHE.clients.filter(c=>[c.name,c.phone,c.address].filter(Boolean).join(' ').toLowerCase().includes(q));
    const html = rows.length
      ? `<table><thead><tr><th>Nazwa</th><th>Telefon</th><th>Adres</th></tr></thead><tbody>`+
        rows.map(c=>`<tr><td>${c.name||''}</td><td>${c.phone||''}</td><td>${c.address||''}</td></tr>`).join('')+
        `</tbody></table>`
      : `<div class="muted">Brak kontrahentÃ³w.</div>`;
    $('#c_list').innerHTML = html;
  }
  async function saveClient(){
    const name=$('#c_name').value.trim(); if(!name){ alert('Podaj nazwÄ™'); return; }
    const phone=$('#c_phone').value.trim()||null;
    const adr=[ $('#c_street').value.trim(), $('#c_postal').value.trim(), $('#c_city').value.trim(), $('#c_country').value.trim()||'Polska' ]
               .filter(Boolean).join(', ');
    const { error } = await supa.from('seedorders_clients').upsert({ name, phone:phone||null, address: adr||null }).select().single();
    if(error){ alert('BÅ‚Ä…d: '+error.message); return; }
    $('#c_out').textContent='Zapisano âœ…'; await loadClients();
  }

  $('#c_toggle').addEventListener('click',()=>$('#c_list').classList.toggle('hide'));
  $('#c_new').addEventListener('click',clearClientForm);
  $('#c_save').addEventListener('click',saveClient);
  $('#c_reload').addEventListener('click',loadClients);
  $('#c_search').addEventListener('input',renderClients);

  // auto-wypeÅ‚nianie telefonu po wyborze klienta
  $('#o_client').addEventListener('change', ()=>{
    const name=$('#o_client').value.trim().toLowerCase();
    const c = CACHE.clients.find(x=>x.name.toLowerCase()===name);
    $('#o_phone').value = c?.phone || '';
  });

  /************** 6) ZAMÃ“WIENIA **************/
  async function loadOrders(){
    const [o,i] = await Promise.all([
      supa.from('seedorders_orders').select('*').order('created_at',{ascending:false}).limit(60),
      supa.from('seedorders_items').select('*'),
    ]);
    if(o.error){ $('#o_list').innerHTML=`<div class="err">BÅ‚Ä…d: ${o.error.message}</div>`; return; }
    CACHE.orders=o.data||[]; CACHE.items=i.data||[];
    renderOrders();
  }
  function itemsForOrder(id){ return CACHE.items.filter(p=>p.order_id===id); }
  function sumFor(items){
    let ord=0, del=0;
    items.forEach(p=>{ ord += Number(p.ordered_qty ?? p.ilosc)||0; del += Number(p.delivered_qty||0)||0; });
    return { ordered:ord, delivered:del };
  }
  function remainingFor(order){
    const its=itemsForOrder(order.id);
    const s=sumFor(its); const left=Math.max(0, s.ordered - s.delivered);
    return { total:left };
  }
  function renderOrders(){
    const q = $('#o_search').value.trim().toLowerCase();
    const st = $('#o_status').value;
    let arr = CACHE.orders.slice();
    if(st!=='wszystkie') arr=arr.filter(o=>o.status===st);
    if(q) arr=arr.filter(o=>[o.klient,o.telefon,o.uwagi].concat(itemsForOrder(o.id).map(p=>p.odmiana)).filter(Boolean).join(' ').toLowerCase().includes(q));

    // sortowanie: aktywne najpierw, â€ždostarczoneâ€ na dÃ³Å‚; w obrÄ™bie datÄ… malejÄ…co
    arr.sort((a,b)=>{
      const ar = remainingFor(a); const br = remainingFor(b);
      const adone = ar.total===0, bdone = br.total===0;
      if(adone!==bdone) return adone?1:-1;
      return (new Date(b.created_at)) - (new Date(a.created_at));
    });

    const html = arr.map(o=>{
      const its = itemsForOrder(o.id);
      const sums = sumFor(its);
      const rem = remainingFor(o);
      let cls = rem.total===0 ? 'ord--done' : (sums.delivered>0 ? 'ord--partial' : 'ord--new');
      const head = `
        <div class="ord-head"><div class="ord-title">
          <span class="badge">${o.status||'zamÃ³wione'}</span>
          <b>${(o.created_at||'').slice(0,10)}</b> â€¢ ${o.klient||''} â€¢ <span class="muted">${o.telefon||''}</span>
          <span class="pill">PozostaÅ‚o: ${rem.total}</span>
        </div>
        <div class="ord-actions">
          <select data-id="${o.id}" class="ord-status">
            ${['zamÃ³wione','w realizacji','dostarczone','anulowane'].map(s=>`<option ${o.status===s?'selected':''}>${s}</option>`).join('')}
          </select>
          <button data-del="${o.id}" class="secondary">UsuÅ„</button>
        </div></div>`;
      const rows = its.map(p=>{
        const left = Number(p.remaining_qty ?? Math.max(0,(p.ordered_qty??p.ilosc) - (p.delivered_qty||0)));
        return `<tr>
          <td>${p.kategoria||''} â€¢ ${p.odmiana||''}</td>
          <td class="right">${Number(p.ordered_qty??p.ilosc)||0}</td>
          <td class="right">${Number(p.delivered_qty||0)}</td>
          <td class="right">${left}</td>
          <td class="right">
            <div class="row" style="gap:6px;justify-content:flex-end">
              <input data-pid="${p.id}" class="ship-delta" style="width:70px" type="number" step="1" value="1">
              <button data-ship="${p.id}">OK</button>
              <button data-edit="${p.id}" class="secondary">Edytuj</button>
            </div>
          </td>
        </tr>`
      }).join('');
      return `<div class="card ${cls}">
        ${head}
        <div class="mt8">
          <table>
            <thead><tr><th>Odmiana</th><th class="right">ZamÃ³wiono</th><th class="right">Wydano</th><th class="right">PozostaÅ‚o</th><th class="right">Wydaj / Edytuj</th></tr></thead>
            <tbody>${rows||`<tr><td colspan="5" class="muted">Brak pozycji.</td></tr>`}</tbody>
          </table>
        </div>
      </div>`
    }).join('');
    $('#o_list').innerHTML = html || `<div class="muted">Brak zamÃ³wieÅ„.</div>`;

    // zdarzenia
    $$('.ord-status').forEach(s=>s.addEventListener('change', async e=>{
      const id = e.target.getAttribute('data-id'); const val=e.target.value;
      await supa.from('seedorders_orders').update({status:val}).eq('id',id);
      loadOrders();
    }));
    $$('button[data-del]').forEach(b=>b.addEventListener('click', async e=>{
      const id = e.target.getAttribute('data-del');
      if(confirm('UsunÄ…Ä‡ zamÃ³wienie?')){
        await supa.from('seedorders_orders').delete().eq('id',id);
        await supa.from('seedorders_items').delete().eq('order_id',id);
        loadOrders();
      }
    }));
    $$('button[data-ship]').forEach(b=>b.addEventListener('click', async e=>{
      const pid = e.target.getAttribute('data-ship');
      const delta = Number($(`input[data-pid="${pid}"]`)?.value||0);
      if(!Number.isFinite(delta) || delta<=0){ alert('Podaj iloÅ›Ä‡ do wydania'); return; }
      const { error } = await supa.rpc('upsert_delivery_simple', { p_item_id: pid, p_delta: delta });
      if(error){ alert('BÅ‚Ä…d wydania: '+error.message); return; }
      loadOrders();
    }));
    $$('button[data-edit]').forEach(b=>b.addEventListener('click', async e=>{
      const pid = e.target.getAttribute('data-edit');
      const rec = CACHE.items.find(x=>x.id===pid); if(!rec){ alert('Nie znaleziono pozycji'); return; }
      const nowQty = prompt('Nowa iloÅ›Ä‡ zamÃ³wiona:', rec.ordered_qty ?? rec.ilosc ?? 1);
      if(nowQty===null) return;
      const qn = Number(nowQty);
      if(!Number.isFinite(qn) || qn<0){ alert('NieprawidÅ‚owa iloÅ›Ä‡'); return; }
      const { error } = await supa.from('seedorders_items').update({ ordered_qty: qn }).eq('id',pid);
      if(error){ alert('BÅ‚Ä…d: '+error.message); return; }
      loadOrders();
    }));
  }

  async function addOrder(){
    if(!supa) return;
    const klient = $('#o_client').value.trim(); if(!klient) return alert('Podaj kontrahenta');
    const telefon = $('#o_phone').value.trim()||null;
    const kat = $('#o_cat').value;
    const odm = $('#o_var').value.trim(); if(!odm) return alert('Podaj odmianÄ™');
    const qty = Number($('#o_qty').value||1);
    const price = Number($('#o_price').value||0);
    const sup = $('#o_sup').value.trim()||null;
    const note= $('#o_note').value.trim()||null;

    // auto-create client jeÅ›li nie ma
    let cl = CACHE.clients.find(c=>c.name.toLowerCase()===klient.toLowerCase());
    if(!cl){
      const ins = await supa.from('seedorders_clients').insert({name:klient, phone:telefon}).select().single();
      if(ins.error){ alert('BÅ‚Ä…d klienta: '+ins.error.message); return; }
      cl = ins.data;
    }

    // zamÃ³wienie â€ždzisiejszeâ€ lub nowe
    let ord = CACHE.orders.find(o=>o.klient.toLowerCase()===klient.toLowerCase() && (o.created_at||'').slice(0,10)===todayStr() && o.status!=='anulowane');
    if(!ord){
      const ins = await supa.from('seedorders_orders').insert({ klient, telefon, uwagi:note, status:'zamÃ³wione', client_id: cl?.id||null }).select().single();
      if(ins.error){ alert('BÅ‚Ä…d zamÃ³wienia: '+ins.error.message); return; }
      ord = ins.data;
    }else{
      const patch={}; if(telefon) patch.telefon=telefon; if(note) patch.uwagi = (ord.uwagi||'')?`${ord.uwagi}; ${note}`:note;
      await supa.from('seedorders_orders').update(patch).eq('id',ord.id);
    }

    const ins2 = await supa.from('seedorders_items').insert({ order_id: ord.id, kategoria:kat, odmiana:odm, ordered_qty:qty, cena:price, dostawca:sup }).select().single();
    if(ins2.error){ alert('BÅ‚Ä…d pozycji: '+ins2.error.message); return; }

    // wyczyÅ›Ä‡ formularz pozycji
    $('#o_var').value=''; $('#o_qty').value='1'; $('#o_price').value=''; $('#o_note').value='';
    loadOrders();
  }

  $('#o_add').addEventListener('click', addOrder);
  $('#o_reload').addEventListener('click', loadOrders);
  $('#o_search').addEventListener('input', renderOrders);
  $('#o_status').addEventListener('change', renderOrders);

  // auto cena + kategoria po wyborze odmiany
  $('#o_var').addEventListener('change', ()=>{
    const v = $('#o_var').value.trim();
    const p = CACHE.prices.find(x=>x.odmiana===v);
    if(p){ $('#o_cat').value=p.kategoria; $('#o_price').value=p.cena; $('#o_sup').value=p.dostawca||''; }
  });

  /************** 7) RAPORTY **************/
  function setDefaultDates(){
    $('#r_from').value = firstDayMonth();
    $('#r_to').value = todayStr();
  }
  setDefaultDates();

  async function runSums(mode){ // mode: 'sumy' | 'braki'
    const p_from = $('#r_from').value, p_to = $('#r_to').value, p_category = ($('#r_cat').value==='(Wszystkie)')?null:$('#r_cat').value;
    const rpc = mode==='sumy' ? 'report_sums_items_only' : 'report_totals_items_only';
    const { data, error } = await supa.rpc(rpc, { p_from, p_to, p_category });
    if(error){ $('#r_out').innerHTML=`<div class="err">BÅ‚Ä…d: ${error.message}</div>`; return; }
    const rows = data||[];
    let tot={ordered_sum:0, delivered_sum:0, remaining_sum:0};
    const html = rows.length
      ? `<table><thead><tr><th>Kategoria</th><th>Odmiana</th><th class="right">ZamÃ³wiono</th><th class="right">Wydano</th><th class="right">PozostaÅ‚o</th></tr></thead><tbody>`+
        rows.map(r=>{tot.ordered_sum+=Number(r.ordered_sum||0);tot.delivered_sum+=Number(r.delivered_sum||0);tot.remaining_sum+=Number(r.remaining_sum||0);
          return `<tr><td>${r.kategoria||''}</td><td>${r.odmiana||''}</td><td class="right">${r.ordered_sum||0}</td><td class="right">${r.delivered_sum||0}</td><td class="right">${r.remaining_sum||0}</td></tr>`;
        }).join('')+
        `</tbody><tfoot><tr><th colspan="2" class="right">RAZEM</th><th class="right">${tot.ordered_sum}</th><th class="right">${tot.delivered_sum}</th><th class="right">${tot.remaining_sum}</th></tr></tfoot></table>`
      : `<div class="muted">Brak danych w wybranym zakresie.</div>`;
    $('#r_out').innerHTML = html;
    $('#r_info').textContent = `Zakres: ${p_from} â€“ ${p_to}`;
  }
  $('#r_sums').addEventListener('click', ()=>runSums('sumy'));
  $('#r_missing').addEventListener('click', ()=>runSums('braki'));

  // CSV z bieÅ¼Ä…cej tabeli raportu
  $('#r_csv').addEventListener('click', ()=>{
    const tbl = $('#r_out table'); if(!tbl){ alert('Najpierw wyÅ›wietl raport.'); return; }
    const rows = Array.from(tbl.querySelectorAll('tr')).map(tr=>Array.from(tr.children).map(td=>('"'+td.textContent.replace(/"/g,'""')+'"')).join(','));
    const blob = new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='raport.csv'; a.click();
  });

  // raport roczny: kto / co / ile
  $('#r_year_btn').addEventListener('click', async ()=>{
    const y = Number($('#r_year').value||new Date().getFullYear());
    const p_from = `${y}-01-01`, p_to = `${y}-12-31`;
    const { data, error } = await supa.from('seedorders_orders').select('*').gte('created_at',p_from).lte('created_at',p_to);
    if(error){ $('#r_out').innerHTML=`<div class="err">BÅ‚Ä…d: ${error.message}</div>`; return; }
    const ords = data||[];
    const items = (await supa.from('seedorders_items').select('*').gte('created_at',p_from).lte('created_at',p_to)).data||[];
    const byClient = {};
    ords.forEach(o=>{
      const its = items.filter(p=>p.order_id===o.id);
      if(!its.length) return;
      const arr = its.map(p=>`${p.kategoria||''} â€¢ ${p.odmiana||''}: zam. ${p.ordered_qty??p.ilosc||0}, wyd. ${p.delivered_qty||0}`);
      byClient[o.klient] = (byClient[o.klient]||[]).concat(arr);
    });
    const html = Object.keys(byClient).length
      ? Object.entries(byClient).map(([k,arr])=>`<div class="card"><b>${k}</b><ul>${arr.map(x=>`<li>${x}</li>`).join('')}</ul></div>`).join('')
      : `<div class="muted">Brak danych w roku ${y}.</div>`;
    $('#r_out').innerHTML = html;
    $('#r_info').textContent = `Rok: ${y}`;
  });

  /************** 8) ZDARZENIA / START **************/
  $('#p_refresh').addEventListener('click', loadPrices);
  $('#p_save').addEventListener('click', upsertPrice);
  $('#p_del').addEventListener('click', deletePrice);
  ['pf_r','pf_k','pf_z','pf_i'].forEach(id=>$('#'+id).addEventListener('change',renderPrices));
  $('#o_var').addEventListener('input', ()=>{/* datalist */});

  function firstDayMonth(){ const d=new Date(); return new Date(d.getFullYear(),d.getMonth(),1).toISOString().slice(0,10); }
  $('#r_from').value = firstDayMonth(); $('#r_to').value = todayStr();

  collapseInit();

  if(supa){
    Promise.all([loadPrices(), loadClients()]).then(loadOrders).catch(console.error);
  }else{
    setStatus('offline');
  }
  </script>
</body>
</html>
