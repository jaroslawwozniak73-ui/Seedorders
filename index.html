<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SeedOrders ‚Äî wsp√≥lna baza</title>
  <meta name="theme-color" content="#001020">
  <!-- wbudowana favicon (≈ºeby nie by≈Ço 404) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>üå±</text></svg>">
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#001020;color:#e5e7eb;margin:0}
    .wrap{max-width:1100px;margin:24px auto;padding:0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:12px;margin:12px 0}
    h2{margin:0 0 8px}
    input,select,textarea{font:inherit;padding:10px;border:1px solid #374151;border-radius:10px;background:#0b1220;color:#e5e7eb}
    button{cursor:pointer;background:#2563eb;color:#fff;border:0;padding:9px 12px;border-radius:10px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .btn-danger{background:#b91c1c}
    .grid{display:grid;gap:10px}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .grid-2{grid-template-columns:1fr 1fr}
    .right{display:flex;gap:8px;align-items:center;margin-left:auto}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid #374151;padding:8px;text-align:left}
    th{background:#0b1229}
    .small{color:#9ca3af;font-size:13px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2937}
    .ok{background:#065f46}      /* dostarczone (czerwony box ma badge zielony dla czytelno≈õci) */
    .warn{background:#92400e}    /* czƒô≈õciowe */
    .new{background:#1f2937}     /* zam√≥wione */
    .tag{font-size:12px;opacity:.85}
    .muted{opacity:.75}
    .collapse-toggle{cursor:pointer;color:#93c5fd;text-decoration:underline}
    /* Kolory ramek zam√≥wie≈Ñ */
    .box{border:2px solid #1f2937;border-radius:14px;padding:10px;margin:8px 0}
    .box.new{box-shadow:0 0 0 2px rgba(34,197,94,.25) inset}
    .box.part{box-shadow:0 0 0 2px rgba(245,158,11,.35) inset}
    .box.done{box-shadow:0 0 0 2px rgba(239,68,68,.35) inset}
    .pill{border-radius:10px;background:#0b1220;padding:4px 8px;border:1px solid #1f2937}
    .spacer{height:6px}
  </style>
  <!-- Supabase JS (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.1/dist/umd/supabase.js"></script>
</head>
<body>
<div class="wrap">

  <div class="row" style="align-items:center">
    <div style="font-size:18px;font-weight:700">üå± SeedOrders ‚Äî wsp√≥lna baza</div>
    <div class="right small">Status: <span id="status">offline</span></div>
  </div>

  <div class="card">
    <h2>Po≈ÇƒÖczenie z Supabase</h2>
    <div class="small" style="margin-bottom:6px">Te pola zostanƒÖ zapamiƒôtane w przeglƒÖdarce.</div>
    <div class="row">
      <input id="url" placeholder="Supabase URL (https://xxx.supabase.co)" style="flex:1">
      <input id="key" placeholder="Anon public key (ey‚Ä¶)" style="flex:1">
      <button id="connect">Po≈ÇƒÖcz i zapamiƒôtaj</button>
    </div>
  </div>

  <!-- CENNIK -->
  <div class="card">
    <h2>Cennik (seedorders_prices)</h2>
    <div class="row small">
      <label><input type="checkbox" class="p-cat" value="Rzepak" checked> Rzepak</label>
      <label><input type="checkbox" class="p-cat" value="Kukurydza" checked> Kukurydza</label>
      <label><input type="checkbox" class="p-cat" value="Zbo≈ºa" checked> Zbo≈ºa</label>
      <label><input type="checkbox" class="p-cat" value="Inne" checked> Inne</label>
      <span class="muted">‚Äî odhacz, aby filtrowaƒá listƒô odmian</span>
      <div class="right"><button id="p_reload">Od≈õwie≈º</button></div>
    </div>
    <div class="grid grid-3" style="margin-top:8px">
      <input id="p_var" list="dl_var" placeholder="Odmiana"><datalist id="dl_var"></datalist>
      <select id="p_cat">
        <option>Rzepak</option><option>Kukurydza</option><option>Zbo≈ºa</option><option>Inne</option>
      </select>
      <input id="p_price" type="number" step="0.01" placeholder="Cena">
    </div>
    <div class="grid grid-2" style="margin-top:8px">
      <input id="p_sup" placeholder="Dostawca (opcjonalnie)">
      <div class="right">
        <button id="p_save">Zapisz / zaktualizuj</button>
        <button id="p_del" class="btn-danger">Usu≈Ñ</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div><span id="p_toggle" class="collapse-toggle">Poka≈º / ukryj listƒô cennika</span></div>
    <div id="p_list" style="margin-top:8px"></div>
  </div>

  <!-- KONTRAHENCI -->
  <div class="card">
    <h2>Kontrahenci (seedorders_clients)</h2>
    <div class="grid grid-3">
      <input id="c_name" placeholder="Nazwa (np. Jan Kowalski)">
      <input id="c_phone" placeholder="Telefon">
      <input id="c_street" placeholder="Ulica (np. Topolowa 1)">
      <input id="c_postal" placeholder="Kod (np. 09-230)">
      <input id="c_city" placeholder="Miejscowo≈õƒá">
      <input id="c_country" placeholder="Polska" value="Polska">
    </div>
    <div class="row" style="margin-top:8px">
      <button id="c_new" class="pill">Nowy</button>
      <button id="c_save">Zapisz</button>
      <div id="c_saved" class="small muted" style="display:none">Zapisano ‚úÖ</div>
      <div class="right"><button id="c_reload">Od≈õwie≈º listƒô</button></div>
    </div>
    <div class="spacer"></div>
    <input id="c_search" placeholder="Szukaj klienta‚Ä¶" style="width:100%">
    <div class="spacer"></div>
    <div><span id="c_toggle" class="collapse-toggle">Poka≈º / ukryj listƒô kontrahent√≥w</span></div>
    <div id="c_list" style="margin-top:8px"></div>
  </div>

  <!-- ZAM√ìWIENIA -->
  <div class="card">
    <h2>Dodaj zam√≥wienie (seedorders_orders + seedorders_items)</h2>
    <div class="grid grid-3">
      <input id="o_client" list="dl_clients" placeholder="Kontrahent (auto lub wpisz nowego)"><datalist id="dl_clients"></datalist>
      <input id="o_phone" placeholder="Telefon (auto z kartoteki, mo≈ºna wpisaƒá)">
      <select id="o_cat">
        <option>Rzepak</option><option>Kukurydza</option><option>Zbo≈ºa</option><option>Inne</option>
      </select>
    </div>
    <div class="grid grid-3" style="margin-top:8px">
      <input id="o_var" list="dl_var2" placeholder="Odmiana"><datalist id="dl_var2"></datalist>
      <input id="o_qty" type="number" min="1" value="1" placeholder="Ilo≈õƒá">
      <input id="o_price" type="number" step="0.01" placeholder="Cena / szt.">
    </div>
    <div class="grid grid-2" style="margin-top:8px">
      <input id="o_sup" placeholder="Dostawca (opcjonalnie)">
      <input id="o_note" placeholder="Uwagi (opcjonalnie)">
    </div>
    <div class="row" style="margin-top:8px"><button id="o_add">Dodaj pozycjƒô</button></div>

    <div class="spacer"></div>
    <h2>Zam√≥wienia (ostatnie)</h2>
    <div class="row small">
      <input id="o_search" placeholder="Szukaj: klient/odmiana/uwagi‚Ä¶" style="flex:1">
      <select id="o_status">
        <option value="wszystkie">Wszystkie statusy</option>
        <option value="zam√≥wione">zam√≥wione</option>
        <option value="czƒô≈õciowe">czƒô≈õciowe</option>
        <option value="dostarczone">dostarczone</option>
      </select>
      <button id="o_reload">Od≈õwie≈º</button>
    </div>
    <div id="o_list" style="margin-top:8px"></div>
  </div>

  <!-- RAPORTY -->
  <div class="card">
    <h2>üìä Raporty</h2>
    <div class="row">
      <div><label>Od<br><input type="date" id="r_from"></label></div>
      <div><label>Do<br><input type="date" id="r_to"></label></div>
      <div>
        <label>Kategoria<br>
          <select id="r_cat">
            <option>(Wszystkie)</option>
            <option>Rzepak</option><option>Kukurydza</option><option>Zbo≈ºa</option><option>Inne</option>
          </select>
        </label>
      </div>
      <div class="right">
        <button id="r_sums">Poka≈º sumy</button>
        <button id="r_short">Poka≈º braki (pozosta≈Ço)</button>
      </div>
    </div>
    <div id="r_out" style="margin-top:8px"></div>

    <div class="spacer"></div>
    <div class="row">
      <div><label>Rok<br><input id="r_year" type="number" min="2000" max="2100"></label></div>
      <button id="r_year_btn">Raport roczny: kto/co/ile</button>
      <button id="r_csv">Pobierz CSV</button>
    </div>
    <div id="r_people" class="small" style="margin-top:8px"></div>
  </div>

</div>

<script>
/************** 1) KONFIGURACJA STA≈ÅEGO PO≈ÅƒÑCZENIA **************/
const SUPABASE_URL_FIXED  = "https://llatxyfdpurbniewhjft.supabase.co";
const SUPABASE_ANON_FIXED = "PASTE_ME"; // <== WSTAW sw√≥j ANON KEY (albo zostaw; wtedy u≈ºyje localStorage 'sb_key')

// 2) Pomocnicze
const $  = (q,root=document)=>root.querySelector(q);
const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
const money = n => (Number(n)||0).toFixed(2).replace('.',',');
const setStatus = t => { const el=$('#status'); if(el) el.textContent=t; };
const todayStr = () => new Date().toISOString().slice(0,10);

let supa=null;
let CACHE={prices:[], clients:[], orders:[], items:[]};

// 3) SINGLETON Supabase (zero duplikat√≥w + w≈Çasny storageKey)
function createClientSingleton(){
  if(window.__SEEDORDERS_SUPA__) return window.__SEEDORDERS_SUPA__;
  const url = SUPABASE_URL_FIXED || localStorage.getItem('sb_url') || "";
  const kFromLS = localStorage.getItem('sb_key') || "";
  const key = (SUPABASE_ANON_FIXED==="PASTE_ME") ? kFromLS : SUPABASE_ANON_FIXED;
  if(!url || !key){ setStatus('offline'); return null; }
  const cli = window.supabase.createClient(url, key, {
    auth: { storageKey:'seedorders-auth', autoRefreshToken:true, persistSession:true, detectSessionInUrl:false }
  });
  localStorage.setItem('sb_url', url);
  localStorage.setItem('sb_key', key);
  if($('#url')) $('#url').value = url;
  if($('#key')) $('#key').value = key.slice(0,10)+'‚Ä¶';
  setStatus('online');
  return window.__SEEDORDERS_SUPA__ = cli;
}

// 4) Po≈ÇƒÖczenie ‚ÄúPo≈ÇƒÖcz i zapamiƒôtaj‚Äù
$('#connect').onclick = ()=>{
  const url = $('#url').value.trim();
  const key = $('#key').value.trim();
  if(!/^https:\/\/.+\.supabase\.co\/?$/.test(url)) { alert('Podaj poprawny URL Supabase'); return; }
  if(!key || !key.startsWith('ey')) { alert('Podaj poprawny anon key'); return; }
  localStorage.setItem('sb_url', url);
  localStorage.setItem('sb_key', key);
  window.__SEEDORDERS_SUPA__ = null; // wyczy≈õƒá singleton
  supa = createClientSingleton();
  if(supa){ loadAll(); }
};

// 5) CENNIK
async function loadPrices(){
  const cats = $$('.p-cat').filter(c=>c.checked).map(c=>c.value);
  const { data, error } = await supa.from('seedorders_prices').select('*').order('odmiana');
  if(error){ $('#p_list').textContent = 'B≈ÇƒÖd: '+error.message; return; }
  CACHE.prices = data||[];
  // filtr listy
  const rows = CACHE.prices.filter(r=>cats.includes(r.kategoria));
  $('#p_list').innerHTML = rows.length
    ? `<table><thead><tr><th>Odmiana</th><th>Kategoria</th><th>Cena</th><th>Dostawca</th></tr></thead><tbody>`+
      rows.map(r=>`<tr><td>${r.odmiana}</td><td>${r.kategoria}</td><td>${money(r.cena)}</td><td>${r.dostawca||''}</td></tr>`).join('')+
      `</tbody></table>`
    : `<div class="small muted">Brak pozycji dla zaznaczonych kategorii.</div>`;
  // datalisty
  const dl = $('#dl_var'); dl.innerHTML='';
  rows.forEach(r=>{ const o=document.createElement('option'); o.value=r.odmiana; dl.appendChild(o); });
  const dl2 = $('#dl_var2'); dl2.innerHTML='';
  CACHE.prices.filter(r=>r.kategoria===$('#o_cat').value).forEach(r=>{ const o=document.createElement('option'); o.value=r.odmiana; dl2.appendChild(o); });
}
$('#p_reload').onclick = loadPrices;
$$('.p-cat').forEach(c=>c.onchange=loadPrices);
$('#p_toggle').onclick = ()=>{ const el=$('#p_list'); el.style.display = (el.style.display==='none'?'':'none'); };

$('#p_cat').onchange = ()=>{ // podpowied≈∫ ceny wg cennika
  const cat = $('#p_cat').value;
  const dl = $('#dl_var'); dl.innerHTML='';
  CACHE.prices.filter(r=>r.kategoria===cat).forEach(r=>{ const o=document.createElement('option'); o.value=r.odmiana; dl.appendChild(o); });
};

$('#p_save').onclick = async ()=>{
  const odm = $('#p_var').value.trim();
  const kat = $('#p_cat').value.trim();
  const cena = Number($('#p_price').value)||0;
  const dost = $('#p_sup').value.trim() || null;
  if(!odm){ alert('Podaj odmianƒô'); return; }
  // upsert po (odmiana,kategoria) ‚Äì je≈õli brak unikalnego klucza, robimy ‚Äúmanualny upsert‚Äù
  const { data: exists } = await supa.from('seedorders_prices').select('id').eq('odmiana',odm).eq('kategoria',kat).maybeSingle();
  if(exists){
    const { error } = await supa.from('seedorders_prices').update({cena,dostawca:dost}).eq('id',exists.id);
    if(error){ alert('B≈ÇƒÖd: '+error.message); return; }
  }else{
    const { error } = await supa.from('seedorders_prices').insert({odmiana:odm,kategoria:kat,cena,dostawca:dost});
    if(error){ alert('B≈ÇƒÖd: '+error.message); return; }
  }
  loadPrices();
};

$('#p_del').onclick = async ()=>{
  const odm = $('#p_var').value.trim();
  const kat = $('#p_cat').value.trim();
  if(!odm){ alert('Podaj odmianƒô do usuniƒôcia'); return; }
  const { error } = await supa.from('seedorders_prices').delete().eq('odmiana',odm).eq('kategoria',kat);
  if(error){ alert('B≈ÇƒÖd: '+error.message); return; }
  loadPrices();
};

// 6) KONTRAHENCI
async function loadClients(){
  const { data, error } = await supa.from('seedorders_clients').select('*').order('name');
  if(error){ $('#c_list').textContent = 'B≈ÇƒÖd: '+error.message; return; }
  CACHE.clients = data||[];
  renderClients();
  // datalist do zam√≥wie≈Ñ
  const dl = $('#dl_clients'); dl.innerHTML='';
  CACHE.clients.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; dl.appendChild(o); });
}
function renderClients(){
  const q = ($('#c_search').value||'').toLowerCase();
  const rows = CACHE.clients.filter(c=>[c.name,c.phone,c.address].join(' ').toLowerCase().includes(q));
  $('#c_list').innerHTML = rows.length
    ? `<table><thead><tr><th>Nazwa</th><th>Telefon</th><th>Adres</th></tr></thead><tbody>`+
      rows.map(c=>`<tr><td>${c.name}</td><td>${c.phone||''}</td><td>${c.address||''}</td></tr>`).join('')+
      `</tbody></table>`
    : `<div class="small muted">Brak klient√≥w.</div>`;
}
$('#c_search').oninput = renderClients;
$('#c_toggle').onclick = ()=>{ const el=$('#c_list'); el.style.display=(el.style.display==='none'?'':'none'); };
$('#c_new').onclick = ()=>{ $('#c_name').value=''; $('#c_phone').value=''; $('#c_street').value=''; $('#c_postal').value=''; $('#c_city').value=''; $('#c_country').value='Polska'; };
$('#o_client').addEventListener('change', ()=>{
  const n = $('#o_client').value.trim().toLowerCase();
  const c = CACHE.clients.find(x=>x.name.toLowerCase()===n);
  if(c) $('#o_phone').value = c.phone||'';
});

$('#c_save').onclick = async ()=>{
  const name=$('#c_name').value.trim();
  const phone=$('#c_phone').value.trim()||null;
  const addr = [$('#c_street').value.trim(), $('#c_postal').value.trim(), $('#c_city').value.trim(), ($('#c_country').value.trim()||'Polska')].filter(Boolean).join(', ');
  if(!name){ alert('Podaj nazwƒô klienta'); return; }
  // upsert po name
  const { data: ex } = await supa.from('seedorders_clients').select('id').eq('name',name).maybeSingle();
  if(ex){
    const { error } = await supa.from('seedorders_clients').update({phone,address:addr}).eq('id',ex.id);
    if(error){ alert('B≈ÇƒÖd: '+error.message); return; }
  }else{
    const { error } = await supa.from('seedorders_clients').insert({name,phone,address:addr});
    if(error){ alert('B≈ÇƒÖd: '+error.message); return; }
  }
  $('#c_saved').style.display='inline';
  setTimeout(()=>$('#c_saved').style.display='none',1500);
  loadClients();
};

// 7) ZAM√ìWIENIA
$('#o_cat').onchange = ()=>{
  const cat=$('#o_cat').value;
  const dl=$('#dl_var2'); dl.innerHTML='';
  CACHE.prices.filter(r=>r.kategoria===cat).forEach(r=>{ const o=document.createElement('option'); o.value=r.odmiana; dl.appendChild(o); });
  // podpowied≈∫ ceny
  $('#o_var').oninput();
};
$('#o_var').oninput = ()=>{
  const cat=$('#o_cat').value, v=$('#o_var').value.trim().toLowerCase();
  const p=CACHE.prices.find(r=>r.kategoria===cat && r.odmiana.toLowerCase()===v);
  if(p){ $('#o_price').value = Number(p.cena||0); $('#o_sup').value = p.dostawca||''; }
};

$('#o_add').onclick = async ()=>{
  const klient = $('#o_client').value.trim();
  const telefon = $('#o_phone').value.trim()||null;
  const kat = $('#o_cat').value.trim();
  const odm = $('#o_var').value.trim();
  const qty = Number($('#o_qty').value)||0;
  const cena = Number($('#o_price').value)||0;
  const dost = $('#o_sup').value.trim()||null;
  const uw = $('#o_note').value.trim()||null;
  if(!klient){ alert('Podaj klienta'); return; }
  if(!odm){ alert('Podaj odmianƒô'); return; }
  if(qty<=0){ alert('Podaj ilo≈õƒá > 0'); return; }

  // auto-create client (po name)
  let client_id=null;
  const { data: cex } = await supa.from('seedorders_clients').select('id').eq('name',klient).maybeSingle();
  if(cex){ client_id=cex.id; if(telefon){ await supa.from('seedorders_clients').update({phone:telefon}).eq('id',client_id); } }
  else{
    const { data:ins, error } = await supa.from('seedorders_clients').insert({name:klient, phone:telefon}).select().single();
    if(error){ alert('B≈ÇƒÖd klienta: '+error.message); return; }
    client_id=ins.id;
  }

  // order dla dzi≈õ lub ostatni ‚Äúzam√≥wione‚Äù
  const { data: oex } = await supa.from('seedorders_orders').select('*').eq('client',klient).order('created_at',{ascending:false}).limit(1).maybeSingle();
  let ordId=null;
  if(oex && oex.status!=='dostarczone'){ // podpinamy
    ordId=oex.id;
    // scalamy notatkƒô/telefon je≈õli podano
    const patch={}; if(uw) patch.notes=((oex.notes||'')?oex.notes+' | ':'')+uw; if(telefon) patch.phone=telefon;
    if(Object.keys(patch).length) await supa.from('seedorders_orders').update(patch).eq('id',ordId);
  }else{
    const { data:ins, error } = await supa.from('seedorders_orders').insert({client:klient, phone:telefon, notes:uw||null, status:'zam√≥wione', client_id:client_id||null}).select().single();
    if(error){ alert('B≈ÇƒÖd zam√≥wienia: '+error.message); return; }
    ordId=ins.id;
  }

  // pozycja
  const { error: e2 } = await supa.from('seedorders_items').insert({
    order_id: ordId, kategoria: kat, odmiana: odm, ilosc: qty, cena: cena, dostawca: dost, delivered_qty: 0
  });
  if(e2){ alert('B≈ÇƒÖd pozycji: '+e2.message); return; }

  $('#o_var').value=''; $('#o_qty').value='1'; $('#o_price').value=''; $('#o_sup').value=''; $('#o_note').value='';
  await loadOrders();
  await loadClients();
};

async function loadOrders(){
  const { data: ord, error:oerr } = await supa.from('seedorders_orders').select('*').order('created_at',{ascending:false}).limit(80);
  const { data: its, error:ierr } = await supa.from('seedorders_items').select('*');
  if(oerr||ierr){ $('#o_list').textContent='B≈ÇƒÖd: '+(oerr?.message||ierr?.message); return; }
  CACHE.orders=ord||[]; CACHE.items=its||[];
  renderOrders();
}

function renderOrders(){
  const statusFilter = $('#o_status').value;
  const q = ($('#o_search').value||'').toLowerCase();
  // grupuj po zam√≥wieniu
  const map = new Map();
  CACHE.orders.forEach(o=>map.set(o.id,{o, items:[]}));
  CACHE.items.forEach(p=>{ if(map.has(p.order_id)) map.get(p.order_id).items.push(p); });

  // oblicz status per zam.
  const groups = Array.from(map.values()).map(g=>{
    const ordered = g.items.reduce((s,x)=>s+(Number(x.ilosc)||0),0);
    const delivered = g.items.reduce((s,x)=>s+(Number(x.delivered_qty)||0),0);
    const remaining = ordered - delivered;
    let stat='zam√≥wione';
    if(ordered>0 && delivered>0 && remaining>0) stat='czƒô≈õciowe';
    if(ordered>0 && remaining<=0) stat='dostarczone';
    return {...g, ordered, delivered, remaining, stat};
  });

  // filtr tekstowy
  const filtered = groups.filter(g=>{
    const text = [g.o.client,g.o.phone,g.o.notes, ...g.items.map(i=>i.odmiana)].join(' ').toLowerCase();
    return text.includes(q);
  }).filter(g => statusFilter==='wszystkie' ? true : g.stat===statusFilter);

  // sort: dostarczone na d√≥≈Ç, potem najnowsze
  filtered.sort((a,b)=>{
    const rank = s => s.stat==='dostarczone'?2 : s.stat==='czƒô≈õciowe'?1 : 0;
    if(rank(a)!==rank(b)) return rank(a)-rank(b);
    return new Date(b.o.created_at) - new Date(a.o.created_at);
  });

  // render
  const html = filtered.map(g=>{
    const colorClass = g.stat==='dostarczone'?'done':(g.stat==='czƒô≈õciowe'?'part':'new');
    const badgeClass = g.stat==='dostarczone'?'ok':(g.stat==='czƒô≈õciowe'?'warn':'new');
    const head = `
      <div class="row" style="align-items:center;gap:8px">
        <span class="badge ${badgeClass}">${g.stat}</span>
        <div class="tag">${(g.o.created_at||'').slice(0,10)}</div>
        <div style="font-weight:600">${g.o.client}</div>
        <div class="tag">‚Ä¢ ${g.o.phone||''}</div>
        <div class="pill">Pozosta≈Ço: ${g.remaining}</div>
        <div class="right">
          <select class="statussel" data-id="${g.o.id}">
            <option ${g.o.status==='zam√≥wione'?'selected':''}>zam√≥wione</option>
            <option ${g.o.status==='czƒô≈õciowe'?'selected':''}>czƒô≈õciowe</option>
            <option ${g.o.status==='dostarczone'?'selected':''}>dostarczone</option>
          </select>
          <button class="del-order" data-id="${g.o.id}">Usu≈Ñ</button>
        </div>
      </div>`;
    const rows = g.items.map(it=>{
      const left = (Number(it.ilosc)||0)-(Number(it.delivered_qty)||0);
      return `<tr>
        <td>${it.kategoria} ‚Ä¢ ${it.odmiana}</td>
        <td style="text-align:right">${it.ilosc||0}</td>
        <td style="text-align:right">${it.delivered_qty||0}</td>
        <td style="text-align:right">${left}</td>
        <td style="width:120px">
          <div class="row" style="gap:6px">
            <input class="ship-n" data-id="${it.id}" type="number" step="1" min="1" value="1" style="width:64px">
            <button class="ship-ok" data-id="${it.id}">OK</button>
          </div>
        </td>
        <td><button class="edit-it" data-id="${it.id}">Edytuj</button></td>
      </tr>`;
    }).join('');
    return `<div class="box ${colorClass}">
      ${head}
      <div style="margin-top:8px">
        <table>
          <thead><tr><th>Odmiana</th><th>Zam√≥wiono</th><th>Wydano</th><th>Pozosta≈Ço</th><th>Wydaj</th><th>Edytuj</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
  }).join('');
  $('#o_list').innerHTML = html || `<div class="small muted">Brak zam√≥wie≈Ñ</div>`;

  // akcje
  $$('#o_list .ship-ok').forEach(b=>b.onclick = onShip);
  $$('#o_list .edit-it').forEach(b=>b.onclick = onEditItem);
  $$('#o_list .dell').forEach(b=>b.onclick = onDeleteItem);
  $$('#o_list .statussel').forEach(s=>s.onchange = async (e)=>{
    const id = e.target.getAttribute('data-id');
    await supa.from('seedorders_orders').update({status:e.target.value}).eq('id',id);
    loadOrders();
  });
  $$('#o_list .del-order').forEach(b=>b.onclick = async (e)=>{
    const id = e.target.getAttribute('data-id');
    if(confirm('UsunƒÖƒá zam√≥wienie?')){ await supa.from('seedorders_orders').delete().eq('id',id); loadOrders(); }
  });
}

async function onShip(e){
  const id = e.currentTarget.getAttribute('data-id');
  const inp = document.querySelector(`input.ship-n[data-id="${id}"]`);
  const delta = Number(inp.value)||0;
  if(delta<=0) return;
  const { data:it } = await supa.from('seedorders_items').select('*').eq('id',id).single();
  if(!it) return;
  const delivered = Math.min((Number(it.ilosc)||0), (Number(it.delivered_qty)||0) + delta);
  await supa.from('seedorders_items').update({delivered_qty:delivered}).eq('id',id);
  // auto-zmiana statusu zam√≥wienia przy pe≈Çnym wydaniu
  const { data: its } = await supa.from('seedorders_items').select('*').eq('order_id', it.order_id);
  const ordered = its.reduce((s,x)=>s+(Number(x.ilosc)||0),0);
  const deliv = its.reduce((s,x)=>s+(Number(x.delivered_qty)||0),0);
  const stat = deliv>=ordered ? 'dostarczone' : (deliv>0 ? 'czƒô≈õciowe':'zam√≥wione');
  await supa.from('seedorders_orders').update({status:stat}).eq('id',it.order_id);
  loadOrders();
}

async function onEditItem(e){
  const id = e.currentTarget.getAttribute('data-id');
  const { data:it } = await supa.from('seedorders_items').select('*').eq('id',id).single();
  if(!it) return;
  const qty = prompt(`Zmie≈Ñ ilo≈õƒá dla: ${it.kategoria} ‚Ä¢ ${it.odmiana}`, it.ilosc);
  if(qty===null) return;
  const price = prompt('Zmie≈Ñ cenƒô (opcjonalnie)', it.cena ?? '');
  await supa.from('seedorders_items').update({ilosc:Number(qty)||0, cena: price!==null?Number(price)||null:it.cena}).eq('id',id);
  loadOrders();
}

$('#o_reload').onclick = loadOrders;
$('#o_search').oninput = renderOrders;
$('#o_status').onchange = renderOrders;

// 8) RAPORTY
function setDefaultDates(){
  const d = new Date(); const f = new Date(d.getFullYear(), d.getMonth(), 1);
  $('#r_from').value = f.toISOString().slice(0,10);
  $('#r_to').value = d.toISOString().slice(0,10);
  $('#r_year').value = d.getFullYear();
}
async function runReport(showShort=false){
  const from = $('#r_from').value, to=$('#r_to').value, cat=$('#r_cat').value;
  // pobierz items + join order created_at
  const { data: ord } = await supa.from('seedorders_orders').select('id,created_at');
  const id2date = new Map(); (ord||[]).forEach(o=>id2date.set(o.id,o.created_at));
  const { data: its } = await supa.from('seedorders_items').select('*');
  const list = (its||[]).filter(i=>{
    const dt = (id2date.get(i.order_id)||'').slice(0,10);
    if(!dt) return false;
    if(from && dt<from) return false;
    if(to && dt>to) return false;
    if($('#r_cat').value!=='(Wszystkie)' && i.kategoria!==$('#r_cat').value) return false;
    return true;
  });
  // sumowanie
  const key = i=>`${i.kategoria}|||${i.odmiana}`;
  const map=new Map();
  list.forEach(i=>{
    const k=key(i); if(!map.has(k)) map.set(k,{kategoria:i.kategoria,odmiana:i.odmiana, zam:0, wyd:0});
    const r=map.get(k); r.zam+=(Number(i.ilosc)||0); r.wyd+=(Number(i.delivered_qty)||0);
  });
  const rows=[...map.values()].map(r=>({...r, poz: r.zam-r.wyd}));
  rows.sort((a,b)=>a.kategoria.localeCompare(b.kategoria)||a.odmiana.localeCompare(b.odmiana));
  const tot = rows.reduce((s,r)=>({zam:s.zam+r.zam,wyd:s.wyd+r.wyd,poz:s.poz+r.poz}),{zam:0,wyd:0,poz:0});
  const filtered = showShort ? rows.filter(r=>r.poz>0) : rows;
  $('#r_out').innerHTML = `<table><thead><tr><th>Kategoria</th><th>Odmiana</th><th>Zam√≥wiono</th><th>Wydano</th><th>Pozosta≈Ço</th></tr></thead>
  <tbody>${filtered.map(r=>`<tr><td>${r.kategoria}</td><td>${r.odmiana}</td><td>${r.zam}</td><td>${r.wyd}</td><td>${r.poz}</td></tr>`).join('')}</tbody>
  <tfoot><tr><th colspan="2" style="text-align:right">RAZEM</th><th style="text-align:right">${tot.zam}</th><th style="text-align:right">${tot.wyd}</th><th style="text-align:right">${tot.poz}</th></tr></tfoot>
  </table>
  <div class="small muted">Zakres: ${from||'‚Äì'} ‚Äî ${to||'‚Äì'}</div>`;
}
$('#r_sums').onclick = ()=>runReport(false);
$('#r_short').onclick = ()=>runReport(true);

$('#r_year_btn').onclick = async ()=>{
  const year = Number($('#r_year').value);
  const from = `${year}-01-01`, to = `${year}-12-31`;
  const { data: ord } = await supa.from('seedorders_orders').select('id,client,created_at');
  const id2 = new Map(); (ord||[]).forEach(o=>id2.setContent
::contentReference[oaicite:0]{index=0}
