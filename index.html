<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SeedOrders — wspólna baza (Supabase)</title>
  <meta name="theme-color" content="#0b1020"/>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1020;color:#e5e7eb;margin:0}
    .wrap{max-width:1100px;margin:14px auto;padding:0 10px}
    .row{display:flex;gap:8px;align-items:center}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:14px;margin:12px 0}
    h2{margin:0 0 8px 0}
    input,button,select,textarea{font:inherit;padding:9px;border-radius:10px;border:1px solid #374151;background:#0b1220;color:#e5e7eb}
    button{cursor:pointer}
    .grid{display:grid;gap:10px}
    .grid.e3{grid-template-columns:1fr 1fr 1fr}
    .grid.e2{grid-template-columns:1fr 1fr}
    .small{opacity:.9;font-size:.95rem}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #374151;padding:7px}
    th{background:#0b1220;text-align:left}
    .right{text-align:right}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2937;border:1px solid #374151}
    .muted{opacity:.75;font-size:.9rem}
    .ok{color:#22c55e}.warn{color:#f59e0b}.bad{color:#ef4444}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.0/dist/umd/supabase.js"></script>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="row" style="justify-content:space-between">
    <div><b>🌱 SeedOrders — wspólna baza</b></div>
    <div>Status: <span id="status" class="badge">offline</span></div>
  </div>

  <!-- POŁĄCZENIE -->
  <div class="card">
    <h2>Połączenie z Supabase</h2>
    <div class="small" style="margin-bottom:6px">Te pola zostaną zapamiętane w przeglądarce.</div>
    <div class="grid e3">
      <input id="url" placeholder="Supabase URL (https://xxxx.supabase.co)"/>
      <input id="key" placeholder="Anon public key (eyJ...)"/>
      <button id="connect">Połącz i zapamiętaj</button>
    </div>
  </div>

  <!-- CENNIK -->
  <div class="card">
    <h2>Cennik (seedorders_prices)</h2>

    <div class="grid e3">
      <input id="p_var" placeholder="Odmiana">
      <select id="p_cat">
        <option>Rzepak</option><option>Kukurydza</option><option>Zboża</option><option>Inne</option>
      </select>
      <input id="p_price" type="number" step="0.01" placeholder="Cena">
    </div>

    <div class="grid e3" style="margin-top:8px">
      <input id="p_sup" placeholder="Dostawca (opcjonalnie)">
      <div class="row" style="gap:8px">
        <button id="p_save">Zapisz / zaktualizuj</button>
        <button id="p_delete" style="border-color:#ef4444;color:#fecaca;background:#1b0f10">Usuń</button>
      </div>
      <div class="right"><button id="p_reload">Odśwież listę</button></div>
    </div>

    <div id="p_list" class="small" style="margin-top:8px"></div>
  </div>

  <!-- KONTRAHENCI -->
  <div class="card">
    <h2>Kontrahenci (seedorders_clients)</h2>

    <div class="grid e3">
      <input id="c_name" placeholder="Nazwa kontrahenta">
      <input id="c_phone" placeholder="Telefon (opcjonalnie)">
      <button id="c_add">Dodaj</button>
    </div>

    <div class="row small" style="margin-top:8px">
      <input id="c_search" placeholder="Szukaj klienta..." style="flex:1">
      <div class="right"><button id="c_reload">Odśwież listę</button></div>
    </div>

    <div id="c_list" class="small" style="margin-top:8px"></div>

    <div class="card" style="margin-top:10px">
      <div style="font-weight:600;margin-bottom:6px">Edytuj dane klienta</div>
      <div class="grid e3">
        <input id="e_name" placeholder="(kliknij klienta na liście powyżej) — nazwa" />
        <input id="e_phone" placeholder="Telefon" />
        <input id="e_street" placeholder="Ulica" />
        <input id="e_postal" placeholder="Kod" />
        <input id="e_city" placeholder="Miejscowość" />
        <input id="e_country" value="Polska" />
      </div>
      <div class="row" style="margin-top:8px">
        <button id="e_save">Zapisz zmiany</button>
        <span id="e_info" class="muted"></span>
      </div>
    </div>
  </div>

  <!-- DODAJ ZAMÓWIENIE -->
  <div class="card">
    <h2>Dodaj zamówienie (seedorders_orders + "seedorders_items 1")</h2>

    <div class="grid e3">
      <input id="o_client" list="dl_clients" placeholder="Kontrahent (wpisz lub wybierz)">
      <datalist id="dl_clients"></datalist>
      <input id="o_phone" placeholder="Telefon (auto z kartoteki, można wpisać)">
      <select id="o_cat">
        <option>Rzepak</option><option>Kukurydza</option><option>Zboża</option><option>Inne</option>
      </select>
    </div>

    <div class="grid e3" style="margin-top:8px">
      <input id="o_var" list="dl_var" placeholder="Odmiana"><datalist id="dl_var"></datalist>
      <input id="o_qty" type="number" min="1" step="1" placeholder="Ilość">
      <input id="o_price" type="number" step="0.01" placeholder="Cena / szt.">
    </div>

    <div class="grid e3" style="margin-top:8px">
      <input id="o_sup" placeholder="Dostawca (opcjonalnie)">
      <input id="o_note" placeholder="Uwagi (opcjonalnie)">
      <button id="o_add">Dodaj pozycję</button>
    </div>
  </div>

  <!-- ZAMÓWIENIA (ostatnie) -->
  <div class="card">
    <h2>Zamówienia (ostatnie)</h2>
    <div class="row small">
      <input id="o_search" placeholder="Szukaj: klient/odmiana/uwagi..." style="flex:1">
      <select id="o_status">
        <option value="wszystkie">Wszystkie statusy</option>
        <option value="nowe">Nowe</option>
        <option value="zamówione">Zamówione</option>
        <option value="dostarczone">Dostarczone</option>
        <option value="anulowane">Anulowane</option>
      </select>
      <button id="o_reload">Odśwież</button>
    </div>
    <div id="o_list" style="margin-top:8px"></div>
  </div>

</div>

<script>
(() => {
  // ===== KONFIG / PAMIĘĆ
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  let supa=null;
  const money=(x)=> (Number(x)||0).toLocaleString('pl-PL',{minimumFractionDigits:2,maximumFractionDigits:2});

  function saveCreds(){
    localStorage.setItem('sb_url', $('#url').value.trim());
    localStorage.setItem('sb_key', $('#key').value.trim());
  }
  function loadCreds(){
    $('#url').value = localStorage.getItem('sb_url') || '';
    $('#key').value = localStorage.getItem('sb_key') || '';
  }
  loadCreds();

  // ===== POŁĄCZENIE
  $('#connect').onclick = async ()=>{
    const url=$('#url').value.trim(), key=$('#key').value.trim();
    if(!url||!key){ alert('Wpisz URL i anon key z Supabase.'); return; }
    supa = window.supabase.createClient(url,key);
    saveCreds();
    $('#status').textContent='online';
    $('#status').classList.add('ok');
    await reloadAll();
  };

  // jeśli już mamy klucze – połącz automatycznie
  if($('#url').value && $('#key').value){
    supa = window.supabase.createClient($('#url').value,$('#key').value);
    $('#status').textContent='online'; $('#status').classList.add('ok');
    reloadAll();
  }

  async function reloadAll(){
    await Promise.all([loadPrices(), loadClients(), loadOrders()]);
  }

  // ===== CENNIK
  let CACHE = { prices:[], clients:[], orders:[], items:[] };

  async function loadPrices(){
    if(!supa) return;
    const { data, error } = await supa.from('seedorders_prices').select('*').order('odmiana');
    if(error){ $('#p_list').textContent='Błąd: '+error.message; return; }
    CACHE.prices = data||[];
    const rows = CACHE.prices.map(r=>({
      odmiana: r.odmiana, kategoria:r.kategoria, cena: Number(r.cena||0), dostawca:r.dostawca||''
    }));
    $('#p_list').innerHTML = rows.length
      ? `<table><thead><tr><th>Odmiana</th><th>Kategoria</th><th class="right">Cena</th><th>Dostawca</th></tr></thead><tbody>${
          rows.map(r=>`<tr data-var="${r.odmiana}" data-cat="${r.kategoria}">
            <td>${r.odmiana}</td><td>${r.kategoria}</td><td class="right">${money(r.cena)}</td><td>${r.dostawca||''}</td></tr>`).join('')
        }</tbody></table>`
      : `<div class="muted">Brak pozycji cennika.</div>`;
    // datalist odmian
    const dl = $('#dl_var'); dl.innerHTML = '';
    rows.forEach(r=>{ const o=document.createElement('option'); o.value=r.odmiana; dl.appendChild(o); });
  }
  $('#p_reload').onclick = loadPrices;

  // klik w wiersz cennika = uzupełnij pola
  document.addEventListener('click',(e)=>{
    const tr = e.target.closest('#p_list table tbody tr'); if(!tr) return;
    $('#p_var').value = tr.dataset.var || '';
    $('#p_cat').value = tr.dataset.cat || 'Rzepak';
    const priceCell = tr.children[2]?.textContent||'';
    $('#p_price').value = (priceCell.replace(/[^\d,.-]/g,'').replace(',','.')) || '';
    $('#p_sup').value = tr.children[3]?.textContent||'';
  });

  $('#p_save').onclick = async()=>{
    if(!supa) return alert('Najpierw Połącz.');
    const odm = $('#p_var').value.trim(); if(!odm) return alert('Podaj odmianę');
    const kat = $('#p_cat').value.trim();
    const cena = Number($('#p_price').value||0);
    const dost = $('#p_sup').value.trim() || null;

    // sprawdź czy istnieje
    const { data:exists } = await supa.from('seedorders_prices').select('id').eq('odmiana',odm).eq('kategoria',kat).limit(1);
    if(exists && exists.length){
      const { error } = await supa.from('seedorders_prices').update({ cena, dostawca:dost }).eq('id', exists[0].id);
      if(error) return alert('Błąd: '+error.message);
    } else {
      const { error } = await supa.from('seedorders_prices').insert({ odmiana:odm, kategoria:kat, cena, dostawca:dost });
      if(error) return alert('Błąd: '+error.message);
    }
    await loadPrices();
  };

  $('#p_delete').onclick = async()=>{
    if(!supa) return alert('Najpierw Połącz.');
    const odm = $('#p_var').value.trim(); const kat=$('#p_cat').value.trim();
    if(!odm) return alert('Najpierw kliknij wiersz lub wpisz odmianę.');
    if(!confirm('Usunąć pozycję cennika?')) return;
    const { error } = await supa.from('seedorders_prices').delete().eq('odmiana',odm).eq('kategoria',kat);
    if(error) return alert('Błąd: '+error.message);
    $('#p_var').value=''; $('#p_price').value=''; $('#p_sup').value='';
    await loadPrices();
  };

  // ===== KONTRAHENCI
  async function loadClients(){
    if(!supa) return;
    const { data, error } = await supa.from('seedorders_clients').select('*').order('name');
    if(error){ $('#c_list').textContent='Błąd: '+error.message; return; }
    CACHE.clients=data||[];
    const q = ($('#c_search').value||'').toLowerCase();
    const rows = CACHE.clients.filter(c => [c.name,c.phone,c.street,c.city,c.postal_code].filter(Boolean).join(' ').toLowerCase().includes(q));
    $('#c_list').innerHTML = rows.length
      ? `<table><thead><tr><th>Nazwa</th><th>Telefon</th><th>Adres</th></tr></thead><tbody>${
          rows.map(c=>`<tr data-id="${c.id||''}" data-name="${c.name}">
            <td>${c.name}</td><td>${c.phone||''}</td>
            <td>${[c.street,c.postal_code,c.city,c.country].filter(Boolean).join(', ')}</td>
          </tr>`).join('')
        }</tbody></table>`
      : `<div class="muted">Brak kontrahentów.</div>`;
    // datalist klientów dla „Dodaj zamówienie”
    const dl=$('#dl_clients'); dl.innerHTML='';
    CACHE.clients.forEach(c=>{ const o=document.createElement('option'); o.value=c.name; dl.appendChild(o); });
  }
  $('#c_reload').onclick = loadClients;
  $('#c_search').oninput = loadClients;

  $('#c_add').onclick = async()=>{
    if(!supa) return alert('Najpierw Połącz.');
    const name=$('#c_name').value.trim(); if(!name) return alert('Podaj nazwę');
    const phone=$('#c_phone').value.trim()||null;
    const { error } = await supa.from('seedorders_clients').insert({ name, phone });
    if(error) return alert('Błąd: '+error.message);
    $('#c_name').value=''; $('#c_phone').value='';
    await loadClients();
  };

  // klik w wiersz klienta -> formularz edycji
  document.addEventListener('click',(e)=>{
    const tr = e.target.closest('#c_list table tbody tr'); if(!tr) return;
    const c = CACHE.clients.find(x=>x.id===tr.dataset.id) || CACHE.clients.find(x=>x.name===tr.dataset.name);
    if(!c) return;
    $('#e_name').value = c.name||'';
    $('#e_phone').value = c.phone||'';
    $('#e_street').value = c.street||'';
    $('#e_postal').value = c.postal_code||'';
    $('#e_city').value = c.city||'';
    $('#e_country').value = c.country||'Polska';
    $('#e_save').dataset.id = c.id||'';
    $('#e_info').textContent = 'Załadowano klienta do edycji.';
  });

  $('#e_save').onclick = async()=>{
    const id = $('#e_save').dataset.id;
    const payload = {
      name: $('#e_name').value.trim(),
      phone: $('#e_phone').value.trim()||null,
      street: $('#e_street').value.trim()||null,
      postal_code: $('#e_postal').value.trim()||null,
      city: $('#e_city').value.trim()||null,
      country: $('#e_country').value.trim()||null
    };
    if(!payload.name){ $('#e_info').textContent='Podaj nazwę'; return; }
    let q;
    if(id) q = supa.from('seedorders_clients').update(payload).eq('id', id);
    else q = supa.from('seedorders_clients').update(payload).eq('name', payload.name);
    const { error } = await q;
    $('#e_info').textContent = error ? ('Błąd: '+error.message) : 'Zapisano ✅ (kliknij „Odśwież listę”).';
    if(!error) loadClients();
  };

  // ===== DODAJ ZAMÓWIENIE (+ pozycja)
  $('#o_client').addEventListener('change', ()=>{
    const name = ($('#o_client').value||'').trim().toLowerCase();
    const cl = CACHE.clients.find(c=>c.name.toLowerCase()===name);
    if(cl && cl.phone) $('#o_phone').value=cl.phone;
  });
  $('#o_var').addEventListener('change', ()=>{
    const v = ($('#o_var').value||'').trim();
    const p = CACHE.prices.find(x=>x.odmiana===v);
    if(p){ $('#o_cat').value=p.kategoria; $('#o_price').value=p.cena; $('#o_sup').value=p.dostawca||''; }
  });

  $('#o_add').onclick = async()=>{
    if(!supa) return alert('Najpierw Połącz.');
    const klient = ($('#o_client').value||'').trim(); if(!klient) return alert('Podaj kontrahenta');
    const telefon = ($('#o_phone').value||'').trim()||null;
    const kategoria = $('#o_cat').value.trim();
    const odm = ($('#o_var').value||'').trim(); if(!odm) return alert('Podaj odmianę');
    const qty = parseInt($('#o_qty').value||'0',10); if(!qty) return alert('Podaj ilość');
    const cena = Number($('#o_price').value||0);
    const dost = ($('#o_sup').value||'').trim() || null;
    const uwagi = ($('#o_note').value||'').trim() || null;

    // klient (autocreate)
    let cl = CACHE.clients.find(c=>c.name.toLowerCase()===klient.toLowerCase());
    if(!cl){
      const ins = await supa.from('seedorders_clients').insert({ name:klient, phone:telefon }).select('*').single();
      if(ins.error) return alert('Błąd klient: '+ins.error.message);
      cl = ins.data; CACHE.clients.push(cl);
    }

    // zamówienie dla dziś (lub nowe)
    let ord = CACHE.orders.find(o => (o.klient||'').toLowerCase()===klient.toLowerCase() && (o.status||'nowe')!=='anulowane' && String(o.created_at||'').slice(0,10)===today());
    if(!ord){
      const ins = await supa.from('seedorders_orders').insert({ klient, telefon, uwagi:uwagi||'', status:'nowe', client_id:cl.id||null }).select('*').single();
      if(ins.error) return alert('Błąd tworzenia zamówienia: '+ins.error.message);
      ord = ins.data; CACHE.orders.unshift(ord);
    } else {
      // dopisz/uzupełnij telefon, uwagi, client_id
      const patch={}; if(telefon) patch.telefon=telefon; if(uwagi) patch.uwagi=(ord.uwagi||'')+'\n'+uwagi; if(cl.id) patch.client_id=cl.id;
      if(Object.keys(patch).length){ await supa.from('seedorders_orders').update(patch).eq('id', ord.id); }
    }

    // pozycja w "seedorders_items 1"
    const ins2 = await supa.from('"seedorders_items 1"').insert({
      order_id: ord.id, "kategoria": kategoria, "odmiana": odm, "ilość": qty, "cena": cena, "dostawca": dost
    });
    if(ins2.error) return alert('Błąd pozycji: '+ins2.error.message);

    $('#o_var').value=''; $('#o_qty').value='1'; $('#o_price').value=''; $('#o_note').value='';
    await loadOrders();
  };

  function today(){ return new Date().toISOString().slice(0,10); }

  // ===== ZAMÓWIENIA: lista + pozycje + częściowe wydania
  async function loadOrders(){
    if(!supa) return;
    const [o,i] = await Promise.all([
      supa.from('seedorders_orders').select('*').order('created_at',{ascending:false}).limit(100),
      supa.from('"seedorders_items 1"').select('*')
    ]);
    CACHE.orders = o.data||[]; CACHE.items = i.data||[];
    renderOrders();
  }
  function itemsForOrder(id){
    return CACHE.items.filter(p=>p.order_id===id).map(r=>{
      const ordered = (r.ordered_qty!=null)? Number(r.ordered_qty) : Number(r['ilość']||0);
      const delivered = Number(r.delivered_qty||0);
      const remaining = (r.remaining_qty!=null)? Number(r.remaining_qty) : Math.max(ordered - delivered, 0);
      return { id:r.id, odmiana:r['odmiana'], kategoria:r['kategoria'], ordered, delivered, remaining };
    });
  }
  function colorFor(rem,del){ return rem>0 && del>0 ? 'warn' : (rem>0 ? 'bad' : 'ok'); }

  function renderOrders(){
    const q = ($('#o_search').value||'').toLowerCase();
    const st = $('#o_status').value;
    let arr = CACHE.orders.slice();
    if(st!=='wszystkie') arr=arr.filter(o=> (o.status||'nowe')===st);
    if(q) arr=arr.filter(o=>{
      const txt=[o.klient,o.telefon,o.uwagi].filter(Boolean).join(' ').toLowerCase();
      const iv=itemsForOrder(o.id).map(p=>p.odmiana).join(' ').toLowerCase();
      return (txt+' '+iv).includes(q);
    });

    const box = $('#o_list'); box.innerHTML='';
    if(!arr.length){ box.innerHTML='<div class="muted">Brak zamówień.</div>'; return; }

    arr.forEach(o=>{
      const its = itemsForOrder(o.id);
      const val = its.reduce((a,b)=>a + (Number(b.ordered)||0)*(Number(b.cena||0)), 0);

      const div = document.createElement('div'); div.className='card';
      div.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div>
            <span class="badge">${(o.status||'nowe')}</span>
            <b>${String(o.created_at||'').slice(0,10)}</b>
            <span class="muted">•</span>
            <b>${o.klient||''}</b> ${o.telefon?('• '+o.telefon):''}
            ${o.uwagi?(`<div class="muted">Uwagi: ${o.uwagi}</div>`):''}
          </div>
          <div class="row">
            <select class="o-st">
              <option value="nowe">nowe</option>
              <option value="zamówione">zamówione</option>
              <option value="dostarczone">dostarczone</option>
              <option value="anulowane">anulowane</option>
            </select>
            <button class="o-del" style="margin-left:8px">Usuń zamówienie</button>
          </div>
        </div>
        <div class="small" style="margin-top:6px">
          ${its.length?`
            <table>
              <thead><tr>
                <th>Odmiana</th><th class="right">Zamówiono</th><th class="right">Wydano</th><th class="right">Pozostało</th><th class="right">Wydaj</th>
              </tr></thead>
              <tbody>
                ${its.map(p=>{
                  const cls=colorFor(p.remaining,p.delivered);
                  return `<tr data-id="${p.id}">
                    <td>${p.kategoria||''} • ${p.odmiana||''}</td>
                    <td class="right">${p.ordered}</td>
                    <td class="right">${p.delivered}</td>
                    <td class="right ${cls}">${p.remaining}</td>
                    <td class="right"><input type="number" step="0.001" value="1" style="width:90px"> <button class="ship">OK</button></td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          `:`<div class="muted">Brak pozycji.</div>`}
        </div>
      `;
      // ustaw status w select
      div.querySelector('.o-st').value = (o.status||'nowe');

      // zmiana statusu
      div.querySelector('.o-st').addEventListener('change', async (ev)=>{
        const val = ev.target.value;
        await supa.from('seedorders_orders').update({ status:val }).eq('id', o.id);
      });

      // usunięcie zamówienia
      div.querySelector('.o-del').addEventListener('click', async ()=>{
        if(!confirm('Usunąć zamówienie?')) return;
        await supa.from('seedorders_orders').delete().eq('id', o.id);
        await loadOrders();
      });

      // częściowe wydania
      div.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button.ship'); if(!btn) return;
        const tr = btn.closest('tr'); const itemId = tr.dataset.id;
        const delta = Number(tr.querySelector('input').value||0); if(!delta) return;
        btn.disabled=true; btn.textContent='…';
        try{
          const res = await supa.rpc('upsert_delivery_simple', { p_item_id:itemId, p_delta:delta });
          const r = (res.data && res.data[0]) || {};
          // odśwież liczby w wierszu
          const tds = tr.children;
          tds[2].textContent = Number(r.delivered_qty||0);
          const remaining = (r.remaining_qty!=null)? Number(r.remaining_qty) : Math.max(Number(r.ordered_qty||0) - Number(r.delivered_qty||0), 0);
          tds[3].textContent = remaining;
          tds[3].className = 'right ' + (remaining>0 && Number(r.delivered_qty||0)>0 ? 'warn' : (remaining>0 ? 'bad' : 'ok'));
        }catch(err){
          alert('Błąd wydania: '+(err.message||err));
        }finally{
          btn.disabled=false; btn.textContent='OK';
        }
      });

      $('#o_list').appendChild(div);
    });
  }

  $('#o_reload').onclick = loadOrders;
  $('#o_search').oninput = renderOrders;
  $('#o_status').onchange = renderOrders;
})();
</script>
</body>
</html>
