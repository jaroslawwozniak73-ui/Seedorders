<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SeedOrders ‚Äî wsp√≥lna baza (Supabase)</title>
  <meta name="theme-color" content="#0b1020"/>
  <style>
    :root{
      --bg:#0b1020;--fg:#e5e7eb;--fg-dim:#9aa3b2;
      --card:#111827;--card-br:#1f2937;--accent:#2563eb;--accent-2:#0ea5e9;
      --ok:#10b981;--warn:#f59e0b;--bad:#dc2626;
      --row-gap:10px;
    }
    html,body{background:#0b1020;color:var(--fg);margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:20px auto;padding:0 12px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:var(--card);border:1px solid var(--card-br);border-radius:12px;padding:14px;margin:12px 0}
    h2{margin:0 0 8px}
    input,select,textarea,button{width:100%;box-sizing:border-box;border:1px solid #374151;background:#0b1229;color:var(--fg);padding:9px;border-radius:9px}
    input[type="checkbox"]{width:auto}
    button{cursor:pointer;background:#2563eb;border-color:#2563eb}
    button.ghost{background:#0b1229;border-color:#374151}
    .btn-line{display:flex;gap:8px;align-items:center}
    .muted{color:var(--fg-dim);font-size:12px}
    .right{margin-left:auto}
    .grid{display:grid;gap:8px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    .collapse-head{display:flex;align-items:center;gap:8px;margin:6px 0}
    .badge{display:inline-block;padding:3px 9px;border-radius:999px;background:#0b1229;border:1px solid #374151;font-size:12px}
    .status{font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #374151;padding:8px;text-align:left}
    th{background:#0b1229}
    /* Karty zam√≥wie≈Ñ wg statusu */
    .ord{border-radius:14px;border:1px solid #224;}
    .ord.s-new{box-shadow:inset 0 0 0 9999px rgba(16,185,129,.12)}
    .ord.s-part{box-shadow:inset 0 0 0 9999px rgba(245,158,11,.12)}
    .ord.s-done{box-shadow:inset 0 0 0 9999px rgba(220,38,38,.12)}
    .ord-head{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 10px 0}
    .ord-meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .small{font-size:12px;color:var(--fg-dim)}
    .ok{color:#10b981}
    .warn{color:#f59e0b}
    .bad{color:#ef4444}
    .kicker{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .hidden{display:none;}
  </style>
  <!-- Supabase UMD (pewny CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.0/dist/umd/supabase.js"></script>
</head>
<body>
<div class="wrap">

  <!-- üîå Po≈ÇƒÖczenie -->
  <div class="card">
    <div class="kicker">
      <b>üå± SeedOrders ‚Äî wsp√≥lna baza</b>
      <span class="small">Po≈ÇƒÖcz z Supabase (URL + anon key). Te pola zostanƒÖ zapamiƒôtane w przeglƒÖdarce.</span>
      <span class="right">Status: <span id="status" class="badge">offline</span></span>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="sb_url" placeholder="https://xxxx.supabase.co"/>
      <input id="sb_key" placeholder="Anon public key (eyJ...)"/>
      <button id="connect">Po≈ÇƒÖcz i zapamiƒôtaj</button>
    </div>
  </div>

  <!-- üí≤ Cennik -->
  <div class="card" id="price-card">
    <h2>Cennik (seedorders_prices)</h2>
    <div class="kicker small">
      <label><input type="checkbox" class="pf" value="Rzepak" checked> Rzepak</label>
      <label><input type="checkbox" class="pf" value="Kukurydza" checked> Kukurydza</label>
      <label><input type="checkbox" class="pf" value="Zbo≈ºa" checked> Zbo≈ºa</label>
      <label><input type="checkbox" class="pf" value="Inne" checked> Inne</label>
      <span class="muted">‚Äî odhacz, aby filtrowaƒá listƒô odmian</span>
      <span class="right">
        <button id="p_toggle" class="ghost small">Poka≈º / ukryj listƒô cennika</button>
      </span>
    </div>
    <div class="row">
      <input id="p_var" list="dl_var" placeholder="Odmiana">
      <datalist id="dl_var"></datalist>
      <select id="p_cat">
        <option>Rzepak</option><option>Kukurydza</option><option>Zbo≈ºa</option><option>Inne</option>
      </select>
      <input id="p_price" type="number" step="0.01" placeholder="Cena">
    </div>
    <div class="row">
      <input id="p_sup" placeholder="Dostawca (opcjonalnie)">
      <div class="btn-line">
        <button id="p_save">Zapisz / zaktualizuj</button>
        <button id="p_del" class="ghost">Usu≈Ñ</button>
        <button id="p_reload" class="ghost right">Od≈õwie≈º</button>
      </div>
    </div>
    <div id="p_list" class="hidden"></div>
  </div>

  <!-- üë• Kontrahenci -->
  <div class="card" id="clients-card">
    <h2>Kontrahenci (seedorders_clients)</h2>
    <div class="grid g3">
      <input id="c_name" placeholder="Nazwa (np. Jan Kowalski)">
      <input id="c_phone" placeholder="Telefon">
      <input id="c_street" placeholder="Ulica (np. Topolowa 1)">
      <input id="c_postal" placeholder="Kod (np. 09-230)">
      <input id="c_city" placeholder="Miejscowo≈õƒá">
      <input id="c_country" value="Polska" placeholder="Kraj">
    </div>
    <div class="btn-line" style="margin-top:8px">
      <button id="c_new" class="ghost">Nowy</button>
      <button id="c_save">Zapisz</button>
      <span id="c_saved" class="small ok hidden">Zapisano ‚úÖ</span>
    </div>

    <div class="kicker" style="margin-top:8px">
      <input id="c_search" placeholder="Szukaj klienta..." />
      <button id="c_toggle" class="ghost right">Poka≈º / ukryj listƒô kontrahent√≥w</button>
      <button id="c_reload" class="ghost">Od≈õwie≈º listƒô</button>
    </div>
    <div id="c_list" class="hidden"></div>
  </div>

  <!-- üßæ Zam√≥wienia -->
  <div class="card">
    <h2>Dodaj zam√≥wienie (seedorders_orders + ‚Äûseedorders_items 1‚Äù)</h2>
    <div class="grid g3">
      <select id="o_client"></select>
      <input id="o_phone" placeholder="Telefon (auto)">
      <select id="o_cat">
        <option>Rzepak</option><option>Kukurydza</option><option>Zbo≈ºa</option><option>Inne</option>
      </select>
    </div>
    <div class="grid g3" style="margin-top:8px">
      <input id="o_var" list="dl_var" placeholder="Odmiana">
      <input id="o_qty" type="number" min="1" value="1" placeholder="Ilo≈õƒá">
      <input id="o_price" type="number" step="0.01" placeholder="Cena / szt.">
    </div>
    <div class="grid g3" style="margin-top:8px">
      <input id="o_sup" placeholder="Dostawca (opcjonalnie)">
      <input id="o_note" placeholder="Uwagi (opcjonalnie)">
      <button id="o_add">Dodaj pozycjƒô</button>
    </div>

    <h2 style="margin-top:16px">Zam√≥wienia (ostatnie)</h2>
    <div class="kicker">
      <input id="o_search" placeholder="Szukaj: klient/odmiana/uwagi..." style="flex:1">
      <select id="o_status">
        <option value="wszystkie">Wszystkie statusy</option>
        <option value="zam√≥wione">zam√≥wione</option>
        <option value="czƒô≈õciowe">czƒô≈õciowo</option>
        <option value="dostarczone">dostarczone</option>
      </select>
      <button id="o_reload" class="ghost">Od≈õwie≈º</button>
    </div>
    <div id="o_list" style="margin-top:8px"></div>
  </div>

  <!-- üìä Raporty -->
  <div class="card">
    <h2>Raporty</h2>
    <div class="grid g3">
      <div><label class="small">Od</label><input type="date" id="r_from"></div>
      <div><label class="small">Do</label><input type="date" id="r_to"></div>
      <div>
        <label class="small">Kategoria</label>
        <select id="r_cat">
          <option value="">(Wszystkie)</option>
          <option>Rzepak</option><option>Kukurydza</option><option>Zbo≈ºa</option><option>Inne</option>
        </select>
      </div>
    </div>
    <div class="btn-line" style="margin-top:8px">
      <button id="r_sum">Poka≈º sumy</button>
      <button id="r_missing" class="ghost">Poka≈º braki (pozosta≈Ço)</button>
    </div>
    <div id="r_out" style="margin-top:8px"></div>

    <div class="grid g3" style="margin-top:14px">
      <div>
        <label class="small">Rok</label>
        <input id="ryear" value="2025">
      </div>
      <div class="btn-line" style="align-items:flex-end">
        <button id="ryear_btn">Raport roczny: kto/co/ile</button>
        <button id="csv_btn" class="ghost">Pobierz CSV</button>
      </div>
    </div>
    <div id="ryear_out" style="margin-top:8px"></div>
  </div>

</div>

<script>
/* ===== Konfiguracja kluczy w localStorage ===== */
const LS_URL  = 'seedorders_supabase_url';
const LS_KEY  = 'seedorders_supabase_anon';

let supa=null;        // klient supabase
let CACHE = { prices:[], clients:[], orders:[], items:[] };

function $(sel){return document.querySelector(sel);}
function fmt(n){ return (Number(n)||0).toLocaleString('pl-PL'); }
function money(n){ return (Number(n)||0).toFixed(2).replace('.',','); }
function today(){ return new Date().toISOString().slice(0,10); }
function firstDayOfMonth(){ const d=new Date(); d.setDate(1); return d.toISOString().slice(0,10); }

/* ===== Po≈ÇƒÖczenie ===== */
function loadConn(){
  $('#sb_url').value = localStorage.getItem(LS_URL) || '';
  $('#sb_key').value = localStorage.getItem(LS_KEY) || '';
}
function saveConn(){
  localStorage.setItem(LS_URL, $('#sb_url').value.trim());
  localStorage.setItem(LS_KEY, $('#sb_key').value.trim());
}
function setStatus(on){ $('#status').textContent = on?'online':'offline'; }

async function connect(){
  const url = $('#sb_url').value.trim();
  const key = $('#sb_key').value.trim();
  if(!/^https:\/\/.*\.supabase\.co$/.test(url) || !key.startsWith('ey')){ alert('Wpisz poprawny URL i anon key'); return; }
  supa = window.supabase.createClient(url, key);
  saveConn(); setStatus(true);
  await reloadAll();
}

$('#connect').onclick=connect;
loadConn();

/* ===== CENNIK ===== */
async function loadPrices(){
  if(!supa) return;
  const { data, error } = await supa.from('seedorders_prices').select('*').order('odmiana');
  if(error){ $('#p_list').innerHTML='<div class="small bad">B≈ÇƒÖd: '+error.message+'</div>'; $('#p_list').classList.remove('hidden'); return; }
  CACHE.prices = data||[];

  // filtr wg checkbox√≥w
  const allowed = [...document.querySelectorAll('.pf')]
      .filter(cb=>cb.checked).map(cb=>cb.value);
  const rows = CACHE.prices.filter(r=>allowed.includes(r.kategoria));

  // lista odmian do datalista i tabela (zwijana)
  $('#dl_var').innerHTML = rows.map(r=>`<option value="${r.odmiana}">`).join('');

  const html = rows.length
   ? `<table><thead><tr><th>Odmiana</th><th>Kategoria</th><th>Cena</th><th>Dostawca</th></tr></thead><tbody>${
        rows.map(r=>`<tr><td>${r.odmiana}</td><td>${r.kategoria}</td><td>${money(r.cena||0)}</td><td>${r.dostawca||''}</td></tr>`).join('')
     }</tbody></table>`
   : '<div class="small muted">Brak pozycji w cenniku.</div>';
  $('#p_list').innerHTML = html;
}

async function upsertPrice(){
  if(!supa) return alert('Najpierw Po≈ÇƒÖcz');
  const odm  = $('#p_var').value.trim();
  const kat  = $('#p_cat').value.trim();
  const cena = Number($('#p_price').value)||0;
  const dost = $('#p_sup').value.trim()||null;
  if(!odm){ alert('Podaj odmianƒô'); return; }

  // Upsert bez ON CONFLICT (bo tabela mo≈ºe nie mieƒá unikalnego indeksu)
  const { data:exist, error:e1 } = await supa
     .from('seedorders_prices')
     .select('*')
     .eq('odmiana',odm).eq('kategoria',kat).maybeSingle();
  if(e1 && e1.code!=='PGRST116') { alert('B≈ÇƒÖd wyszukiwania: '+e1.message); return; }

  if(exist){
    const { error } = await supa.from('seedorders_prices')
      .update({ cena, dostawca:dost }).eq('id', exist.id);
    if(error) return alert('B≈ÇƒÖd aktualizacji: '+error.message);
  }else{
    const { error } = await supa.from('seedorders_prices')
      .insert({ odmiana:odm, kategoria:kat, cena, dostawca:dost });
    if(error) return alert('B≈ÇƒÖd dodawania: '+error.message);
  }
  $('#p_var').value=''; $('#p_price').value=''; $('#p_sup').value='';
  await loadPrices();
}

async function delPrice(){
  const odm=$('#p_var').value.trim(), kat=$('#p_cat').value.trim();
  if(!odm){ alert('Podaj odmianƒô do usuniƒôcia'); return; }
  const { error } = await supa.from('seedorders_prices').delete().eq('odmiana',odm).eq('kategoria',kat);
  if(error) return alert('B≈ÇƒÖd usuwania: '+error.message);
  await loadPrices();
}
$('#p_save').onclick=upsertPrice;
$('#p_del').onclick=delPrice;
$('#p_reload').onclick=loadPrices;
$('#p_toggle').onclick=()=>$('#p_list').classList.toggle('hidden');
document.querySelectorAll('.pf').forEach(cb=>cb.onchange=loadPrices);

/* ===== KONTRAHENCI ===== */
async function loadClients(){
  const { data, error } = await supa.from('seedorders_clients').select('*').order('name');
  if(error){ $('#c_list').innerHTML='<div class="small bad">B≈ÇƒÖd: '+error.message+'</div>'; $('#c_list').classList.remove('hidden'); return; }
  CACHE.clients=data||[];

  // lista zwijana
  const q = $('#c_search').value.trim().toLowerCase();
  const rows = CACHE.clients.filter(c=>[c.name,c.phone,c.address].filter(Boolean).join(' ').toLowerCase().includes(q));
  const html = rows.length
    ? `<table><thead><tr><th>Nazwa</th><th>Telefon</th><th>Adres</th></tr></thead><tbody>${
        rows.map(c=>`<tr><td><a href="#" class="pick" data-name="${c.name.replaceAll('"','&quot;')}">${c.name}</a></td><td>${c.phone||''}</td><td>${c.address||''}</td></tr>`).join('')
      }</tbody></table>`
    : '<div class="small muted">Brak klient√≥w.</div>';
  $('#c_list').innerHTML = html;

  // select do zam√≥wie≈Ñ
  $('#o_client').innerHTML = `<option value="">(wybierz)</option>${
    CACHE.clients.map(c=>`<option value="${c.name}">${c.name}</option>`).join('')
  }`;
  document.querySelectorAll('.pick').forEach(a=>a.onclick=(e)=>{e.preventDefault(); fillClient(a.dataset.name);});
}
function formatAddress({street,postal_code,city,country}){
  const parts = [street, [postal_code,city].filter(Boolean).join(', '), country].filter(Boolean);
  return parts.join(', ');
}
function clearClientForm(){
  ['#c_name','#c_phone','#c_street','#c_postal','#c_city','#c_country'].forEach(id=>$(id).value='');
  $('#c_saved').classList.add('hidden');
}
function fillClient(name){
  const c = CACHE.clients.find(x=>x.name===name);
  if(!c) return;
  $('#c_name').value=c.name||'';
  $('#c_phone').value=c.phone||'';
  $('#c_street').value=c.street||'';
  $('#c_postal').value=c.postal_code||'';
  $('#c_city').value=c.city||'';
  $('#c_country').value=c.country||'Polska';
  $('#o_client').value=c.name;
  $('#o_phone').value=c.phone||'';
}
$('#c_new').onclick=clearClientForm;
$('#c_toggle').onclick=()=>$('#c_list').classList.toggle('hidden');
$('#c_reload').onclick=loadClients;
$('#c_search').oninput=loadClients;

$('#c_save').onclick=async ()=>{
  if(!supa) return alert('Najpierw Po≈ÇƒÖcz');
  const name=$('#c_name').value.trim();
  if(!name) return alert('Podaj nazwƒô klienta');
  const row={
    name,
    phone:($('#c_phone').value||'').trim()||null,
    street:($('#c_street').value||'').trim()||null,
    postal_code:($('#c_postal').value||'').trim()||null,
    city:($('#c_city').value||'').trim()||null,
    country:($('#c_country').value||'').trim()||'Polska',
    address: formatAddress({
      street:$('#c_street').value, postal_code:$('#c_postal').value, city:$('#c_city').value, country:$('#c_country').value
    })
  };
  // update je≈õli istnieje po name (case-insensitive)
  const existing = CACHE.clients.find(c=>c.name.toLowerCase()===name.toLowerCase());
  if(existing){
    const { error } = await supa.from('seedorders_clients').update(row).eq('id',existing.id);
    if(error) return alert('B≈ÇƒÖd aktualizacji: '+error.message);
  }else{
    const { error } = await supa.from('seedorders_clients').insert(row);
    if(error) return alert('B≈ÇƒÖd dodawania: '+error.message);
  }
  $('#c_saved').classList.remove('hidden');
  await loadClients();
};

/* ===== ZAM√ìWIENIA ===== */
async function loadOrders(){
  // 50 najnowszych
  const [o,i] = await Promise.all([
    supa.from('seedorders_orders').select('*').order('created_at',{ascending:false}).limit(50),
    // seedorders_items albo "seedorders_items 1"
    supa.from('seedorders_items').select('*').then(res=>{
      if(res.error && /relation.*does not exist/i.test(res.error.message)){
        return supa.from('seedorders_items 1').select('*');
      }
      return res;
    })
  ]);
  CACHE.orders = o.data||[];
  CACHE.items  = i.data||[];
  renderOrders();
}
function orderItems(order_id){
  return CACHE.items.filter(p=>p.order_id===order_id);
}
function orderStatus(items){
  let ord=0, del=0;
  items.forEach(p=>{
    const il = Number(p.ilo≈õƒá ?? p.ilosc ?? p.qty ?? p.ordered_qty || 0);
    const dv = Number(p.delivered_qty || 0);
    ord+=il; del+=dv;
  });
  if(!ord) return {status:'zam√≥wione', remain:0};
  const remain = Math.max(ord-del,0);
  return {status: remain===0 ? 'dostarczone' : (del>0 ? 'czƒô≈õciowe' : 'zam√≥wione'), remain};
}
function statusClass(s){ return s==='dostarczone'?'s-done':(s==='czƒô≈õciowe'?'s-part':'s-new'); }

function renderOrders(){
  const q = ($('#o_search').value||'').toLowerCase();
  const filt = $('#o_status').value;

  // sort: dostarczone na d√≥≈Ç
  let arr = CACHE.orders.slice();
  arr.sort((a,b)=>{
    const sa = orderStatus(orderItems(a.id)).status;
    const sb = orderStatus(orderItems(b.id)).status;
    const rank = s => s==='dostarczone'?2 : s==='czƒô≈õciowe'?1 : 0;
    if(rank(sa)!==rank(sb)) return rank(sa)-rank(sb);
    return (new Date(b.created_at)) - (new Date(a.created_at));
  });

  const box = $('#o_list'); box.innerHTML='';
  arr.forEach(o=>{
    const its = orderItems(o.id);
    const {status,remain} = orderStatus(its);
    if(filt!=='wszystkie' && status!==filt) return;

    const text = [o.klient,o.telefon||'',o.uwagi||''].concat(its.map(p=>p.odmiana||'')).join(' ').toLowerCase();
    if(q && !text.includes(q)) return;

    const div = document.createElement('div');
    div.className = `ord ${statusClass(status)}`;
    const head = `
      <div class="ord-head">
        <div class="ord-meta">
          <span class="badge status">${status}</span>
          <span class="small">${(o.created_at||'').slice(0,10)}</span>
          <b>${o.klient||''}</b>
          <span class="small">${o.telefon||''}</span>
          <span class="badge">Pozosta≈Ço: ${fmt(remain)}</span>
        </div>
        <div class="btn-line">
          <select class="st">
            <option ${o.status==='zam√≥wione'?'selected':''}>zam√≥wione</option>
            <option ${o.status==='czƒô≈õciowe'?'selected':''}>czƒô≈õciowe</option>
            <option ${o.status==='dostarczone'?'selected':''}>dostarczone</option>
          </select>
          <button class="ghost del">Usu≈Ñ</button>
        </div>
      </div>`;
    const rows = its.map(p=>{
      const il = Number(p.ilo≈õƒá ?? p.ilosc ?? p.ordered_qty || 0);
      const dv = Number(p.delivered_qty || 0);
      const left = Math.max(il-dv,0);
      return `<tr>
        <td>${p.kategoria||''} ‚Ä¢ ${p.odmiana||''}</td>
        <td style="text-align:right">${fmt(il)}</td>
        <td style="text-align:right">${fmt(dv)}</td>
        <td style="text-align:right">${fmt(left)}</td>
        <td style="width:120px">
            <div class="btn-line"><input class="ship" data-id="${p.id}" type="number" step="1" min="1" value="1" style="width:70px"><button class="okbtn">OK</button></div>
        </td>
        <td style="width:90px"><button class="ghost edit" data-id="${p.id}">Edytuj</button></td>
      </tr>`;
    }).join('');
    const tbl = `
      <div style="padding:0 10px 10px">
        <table>
          <thead><tr><th>Odmiana</th><th>Zam√≥wiono</th><th>Wydano</th><th>Pozosta≈Ço</th><th>Wydaj</th><th>Edytuj</th></tr></thead>
          <tbody>${rows || `<tr><td colspan="6" class="small muted">Brak pozycji.</td></tr>`}</tbody>
        </table>
      </div>`;
    div.innerHTML = head + tbl;
    box.appendChild(div);

    // zdarzenia
    div.querySelector('.del').onclick=async ()=>{ if(confirm('UsunƒÖƒá zam√≥wienie?')){ await supa.from('seedorders_orders').delete().eq('id',o.id); await loadOrders();}};
    div.querySelector('.st').onchange=async (e)=>{ await supa.from('seedorders_orders').update({status:e.target.value}).eq('id',o.id); await loadOrders();};

    div.querySelectorAll('.okbtn').forEach(btn=>{
      btn.onclick=async ()=>{
        const id = btn.parentElement.querySelector('.ship').dataset.id;
        const delta = Number(btn.parentElement.querySelector('.ship').value)||0;
        if(!id || !Number.isFinite(delta) || delta<=0) return;
        // RPC prosty: upsert_delivery_simple(p_item_id, p_delta)
        const r = await supa.rpc('upsert_delivery_simple', { p_item_id:id, p_delta:delta });
        if(r.error){ alert('B≈ÇƒÖd wydania: '+r.error.message); return; }
        await loadOrders(); await runReport(); // od≈õwie≈º raporty
      };
    });
    div.querySelectorAll('.edit').forEach(btn=>{
      btn.onclick=async ()=>{
        const id=btn.dataset.id;
        const it = CACHE.items.find(x=>x.id===id); if(!it) return;
        const now = prompt('Zmie≈Ñ ilo≈õƒá (zam√≥wiono):', (it.ilo≈õƒá ?? it.ordered_qty ?? 1));
        if(now===null) return;
        const ilo = Number(now)||0;
        const tname = CACHE.items.some(x=>x.hasOwnProperty('ilo≈õƒá')) ? '"seedorders_items 1"' : 'seedorders_items';
        const { error } = await supa.from(tname).update({ ilo≈õƒá:ilo }).eq('id',id);
        if(error){ alert('B≈ÇƒÖd edycji: '+error.message); return; }
        await loadOrders();
      };
    });
  });
}

$('#o_reload').onclick=loadOrders;
$('#o_search').oninput=renderOrders;
$('#o_status').onchange=renderOrders;

// autofill: select klient -> telefon
$('#o_client').onchange=()=>{
  const name=$('#o_client').value;
  const c=CACHE.clients.find(x=>x.name===name);
  $('#o_phone').value = c?.phone || '';
};
// autofill: kategoria+odmiana -> cena
$('#o_var').addEventListener('change', ()=>{
  const v=$('#o_var').value; const cat=$('#o_cat').value;
  const f=CACHE.prices.find(p=>p.odmiana===v && p.kategoria===cat);
  if(f){ $('#o_price').value = f.cena||''; $('#o_sup').value = f.dostawca||''; }
});

$('#o_add').onclick=async ()=>{
  if(!supa) return alert('Najpierw Po≈ÇƒÖcz');
  const klient=$('#o_client').value.trim(); if(!klient) return alert('Wybierz klienta');
  const telefon=$('#o_phone').value.trim()||null;
  const kategoria=$('#o_cat').value.trim();
  const odm=$('#o_var').value.trim(); if(!odm) return alert('Podaj odmianƒô');
  const ilosc=Number($('#o_qty').value)||0; if(ilosc<=0) return alert('Podaj ilo≈õƒá > 0');
  const cena = Number($('#o_price').value)||0;
  const dost = ($('#o_sup').value||'').trim()||null;
  const uwagi=($('#o_note').value||'').trim()||null;

  // Utw√≥rz/znajd≈∫ KONTRAHENTA (po nazwie)
  let cl = CACHE.clients.find(c=>c.name.toLowerCase()===klient.toLowerCase());
  if(!cl){
    const ins = await supa.from('seedorders_clients').insert({name:klient,phone:telefon}).select().single();
    if(ins.error){ alert('B≈ÇƒÖd klienta: '+ins.error.message); return; }
    cl = ins.data;
  }

  // Zam√≥wienie bie≈ºƒÖce (status != anulowane) z dzisiaj albo nowe
  let ord = CACHE.orders.find(o=> (o.klient||'').toLowerCase()===klient.toLowerCase() && (o.status||'')!=='anulowane' && (o.created_at||'').slice(0,10)===today());
  if(!ord){
    const ins = await supa.from('seedorders_orders').insert({ data:today(), klient, telefon, uwagi, status:'zam√≥wione', client_id: cl.id||null }).select().single();
    if(ins.error){ alert('B≈ÇƒÖd tworzenia zam√≥wienia: '+ins.error.message); return; }
    ord = ins.data;
  }else{
    const patch={}; if(telefon) patch.telefon=telefon; if(uwagi) patch.uwagi=(ord.uwagi||'')+(ord.uwagi?'; ':'')+uwagi;
    if(Object.keys(patch).length) await supa.from('seedorders_orders').update(patch).eq('id',ord.id);
  }

  // Wstaw pozycjƒô do items (obs≈Çuga dw√≥ch nazw tabel)
  let tname='seedorders_items';
  // wykryj ‚Äûseedorders_items 1‚Äù
  const hasWeird = CACHE.items.find(x=>x.hasOwnProperty('ilo≈õƒá')) !== undefined;
  if(hasWeird){ tname='"seedorders_items 1"'; }

  const ins2 = await supa.from(tname).insert({ order_id:ord.id, kategoria, odmiana:odm, 'ilo≈õƒá': ilosc, cena, dostawca: dost }).select().single();
  if(ins2.error){ alert('B≈ÇƒÖd pozycji: '+ins2.error.message); return; }

  // wyczy≈õƒá formularz pozycji
  $('#o_var').value=''; $('#o_qty').value='1'; $('#o_price').value=''; $('#o_sup').value=''; $('#o_note').value='';
  await loadOrders(); await loadPrices(); // od≈õwie≈º (dla autofill)
};

/* ===== RAPORTY ===== */
function setDefaultDates(){
  $('#r_from').value = firstDayOfMonth();
  $('#r_to').value   = today();
}
async function runReport(mode='sum'){
  const p_from=$('#r_from').value||today();
  const p_to  =$('#r_to').value||today();
  const p_cat =$('#r_cat').value||null;

  const out=$('#r_out'); out.textContent='Liczenie‚Ä¶';
  if(mode==='sum'){
    const { data:rows, error:e1 } = await supa.rpc('report_sums_items_only', { p_from, p_to, p_category: p_cat });
    if(e1){ out.innerHTML='<div class="small bad">B≈ÇƒÖd: '+e1.message+'</div>'; return; }
    const { data:tot, error:e2 } = await supa.rpc('report_totals_items_only', { p_from, p_to, p_category: p_cat });
    if(e2){ out.innerHTML='<div class="small bad">B≈ÇƒÖd: '+e2.message+'</div>'; return; }

    let html = `<table><thead><tr><th>Kategoria</th><th>Odmiana</th><th>Zam√≥wiono</th><th>Wydano</th><th>Pozosta≈Ço</th></tr></thead><tbody>`;
    rows.forEach(r=>{ html += `<tr><td>${r.kategoria||''}</td><td>${r.odmiana||''}</td><td style="text-align:right">${fmt(r.ordered_sum||0)}</td><td style="text-align:right">${fmt(r.delivered_sum||0)}</td><td style="text-align:right">${fmt(r.remaining_sum||0)}</td></tr>`; });
    html += `</tbody>`;
    if(tot && tot[0]){
      html += `<tfoot><tr><th colspan="2" style="text-align:right">RAZEM</th>
        <th style="text-align:right">${fmt(tot[0].ordered_total||0)}</th>
        <th style="text-align:right">${fmt(tot[0].delivered_total||0)}</th>
        <th style="text-align:right">${fmt(tot[0].remaining_total||0)}</th></tr></tfoot>`;
    }
    html += `</table><div class="small muted" style="margin-top:6px">Zakres: ${p_from} ‚Äì ${p_to}</div>`;
    out.innerHTML = html;
  }else{
       // braki (pozosta≈Ço > 0)
    const { data: rows, error } = await supa.rpc('report_sums_items_only', { p_from, p_to, p_category: p_cat });
    if (error) { out.innerHTML = '<div class="small bad">B≈ÇƒÖd: ' + error.message + '</div>'; return; }
    const miss = (rows || []).filter(r => (r.remaining_sum || 0) > 0);
    let html = miss.length
      ? '<table><thead><tr><th>Kategoria</th><th>Odmiana</th><th>Pozosta≈Ço</th></tr></thead><tbody>'
      : '<div class="small ok">Brak brak√≥w.</div>';
    if (miss.length) {
      miss.forEach(r => {
        html += '<tr><td>' + (r.kategoria || '') + '</td><td>' + (r.odmiana || '') + '</td><td style="text-align:right">' + fmt(r.remaining_sum || 0) + '</td></tr>';
      });
      html += '</tbody></table>';
    }
    html += '<div class="small muted" style="margin-top:6px">Zakres: ' + p_from + ' ‚Äì ' + p_to + '</div>';
    out.innerHTML = html;
  }
} // ‚Üê koniec funkcji runReport

// przyciski raport√≥w
document.getElementById('r_sum').onclick     = () => runReport('sum');
document.getElementById('r_missing').onclick = () => runReport('missing');

// raport roczny + CSV
document.getElementById('ryear_btn').onclick = async () => {
  const year = Number(document.getElementById('ryear').value) || new Date().getFullYear();
  const from = year + '-01-01', to = year + '-12-31';

  const [o, i] = await Promise.all([
    supa.from('seedorders_orders').select('*').gte('data', from).lte('data', to),
    supa.from('seedorders_items').select('*')
  ]);
  const orders = o.data || [], items = i.data || [];

  const byClient = new Map();
  orders.forEach(ord => {
    const its = items.filter(p => p.order_id === ord.id);
    its.forEach(p => {
      const key = ord.klient || '‚Äî';
      const il  = Number(p['ilo≈õƒá'] ?? p.ordered_qty || 0);
      const dv  = Number(p.delivered_qty || 0);
      const arr = byClient.get(key) || [];
      arr.push({ odmiana: p.odmiana, kategoria: p.kategoria, zam: il, wyd: dv });
      byClient.set(key, arr);
    });
  });

  let html = '';
  byClient.forEach((arr, client) => {
    const sumZ = arr.reduce((s, a) => s + a.zam, 0);
    const sumW = arr.reduce((s, a) => s + a.wyd, 0);
    html += '<div class="card" style="background:#0d142a;border:1px dashed #263042;margin:8px 0">'
          + '<b>' + client + '</b> <span class="small">‚Äî Zam√≥wiono: ' + fmt(sumZ) + ' ‚Ä¢ Wydano: ' + fmt(sumW) + '</span>'
          + '<ul>' + arr.map(a => '<li class="small">' + a.kategoria + ' ‚Ä¢ ' + a.odmiana + ': zam. ' + fmt(a.zam) + ', wyd. ' + fmt(a.wyd) + '</li>').join('') + '</ul>'
          + '</div>';
  });
  document.getElementById('ryear_out').innerHTML = html || '<div class="small muted">Brak danych w tym roku.</div>';

  document.getElementById('csv_btn').onclick = () => {
    const rows = [['Klient', 'Kategoria', 'Odmiana', 'Zam√≥wiono', 'Wydano']];
    byClient.forEach((arr, client) => arr.forEach(a => rows.push([client, a.kategoria, a.odmiana, a.zam, a.wyd])));
    const csv  = rows.map(r => r.map(v => '"' + String(v).replace(/"/g, '""') + '"').join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = 'raport_' + year + '.csv'; a.click();
    URL.revokeObjectURL(url);
  };
};

// ===== INIT =====
async function reloadAll() { await Promise.all([loadPrices(), loadClients(), loadOrders()]); }
setDefaultDates();

// Auto start je≈õli mamy zapisane klucze
(async () => {
  const url = localStorage.getItem(LS_URL);
  const key = localStorage.getItem(LS_KEY);
  if (url && key) {
    try {
      supa = window.supabase.createClient(url, key);
      setStatus(true);
      await reloadAll();
    } catch (e) {
      setStatus(false);
      console.error(e);
    }
  }
})();
</script>
</body>
</html>
 
